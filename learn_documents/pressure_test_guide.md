# 压测学习指南 - 新人 QA 必读

> 本文档整理自实际项目的压测方案，结合资源评估表格，帮助新人 QA 快速理解压测的核心概念和实践方法。

---

## 目录

1. [什么是压测](#1-什么是压测)
2. [核心概念与术语](#2-核心概念与术语)
3. [协议知识](#3-协议知识)
4. [网络基础知识](#4-网络基础知识)
5. [压测前的资源评估](#5-压测前的资源评估)
6. [压测资源统计表详解](#6-压测资源统计表详解)
7. [压测实施流程](#7-压测实施流程)
8. [压测结果分析](#8-压测结果分析)
9. [Sparta 压测工具使用](#9-sparta-压测工具使用)
10. [常见问题与注意事项](#10-常见问题与注意事项)
11. [附录：核心公式速查](#11-附录核心公式速查)
12. [实战案例：Throttle接口压测方案详解](#12-实战案例throttle接口压测方案详解)
13. [监控面板指标详解](#13-监控面板指标详解)
14. [压测指标统计表模板](#14-压测指标统计表模板)

---

## 1. 什么是压测

### 1.1 压测的定义

**压测（Pressure Test / Load Test）** 是通过模拟大量用户并发请求，测试系统在高负载情况下的性能表现和稳定性的测试方法。

### 1.2 通俗理解

> **类比**：压测就像是模拟双十一大促的场景，人为制造大量请求去"压"服务器，看它能不能扛住。就像给汽车做极限测试，看它最快能跑多少码、最高能承受多大负荷。

### 1.3 压测的目的

| 目的 | 说明 |
|------|------|
| **验证系统容量** | 确认系统能处理的最大请求量 |
| **发现性能瓶颈** | 找出系统中最薄弱的环节 |
| **评估扩容需求** | 判断是否需要增加服务器资源 |
| **建立性能基线** | 为后续优化提供参考标准 |
| **避免线上事故** | 确保大促期间系统稳定运行 |

### 1.4 什么时候需要压测

- 新功能上线前
- 大促活动（双11、双12）前
- 系统架构调整后
- 重要接口性能评估
- 定期性能回归测试

---

## 2. 核心概念与术语

### 2.1 性能指标

#### 2.1.1 QPS（Queries Per Second）

**定义**：每秒查询/请求次数，是衡量系统处理能力的核心指标。

```
示例：
- QPS = 1000 表示系统每秒能处理 1000 个请求
- 如果请求量超过系统 QPS 上限，会导致请求排队或失败
```

#### 2.1.2 TPS（Transactions Per Second）

**定义**：每秒事务处理数，通常用于数据库或涉及事务的场景。

```
QPS vs TPS：
- QPS：更通用，适用于 HTTP 接口请求统计
- TPS：更适用于数据库操作或完整业务流程统计
- 在很多场景下，两者可以互换使用
```

#### 2.1.3 RT（Response Time）

**定义**：响应时间，从发送请求到收到响应的时间，单位通常是毫秒（ms）。

```
RT 分类：
- 平均 RT：所有请求响应时间的平均值
- 最小 RT（MIN）：最快的响应时间
- 最大 RT（MAX）：最慢的响应时间
```

#### 2.1.4 P50 / P90 / P95 / P99（百分位数）

**定义**：表示一定百分比的请求响应时间在某个值以内。

| 指标 | 含义 | 示例 |
|------|------|------|
| **P50** | 50%的请求响应时间低于此值 | P50=100ms，表示一半请求在100ms内完成 |
| **P90** | 90%的请求响应时间低于此值 | P90=200ms，表示90%请求在200ms内完成 |
| **P95** | 95%的请求响应时间低于此值 | P95=300ms，表示95%请求在300ms内完成 |
| **P99** | 99%的请求响应时间低于此值 | P99=500ms，表示99%请求在500ms内完成 |

> **为什么用百分位数而不用平均值？**
> 
> 平均值会被极端值影响。例如：10个请求，9个用时100ms，1个用时10秒，平均值是1.09秒，但实际上90%的用户体验是100ms。**P95/P99 更能反映真实用户体验。**

#### 2.1.5 并发数 / 连接数（Connections）

**定义**：同时发起请求的客户端数量。

```
关键公式：
QPS = 并发连接数 × (1 / RT)

示例：
- 如果 RT = 100ms（0.1秒），每个连接每秒可发起 10 个请求
- 100 个并发连接 × 10 = 1000 QPS
```

#### 2.1.6 吞吐量（Throughput）

**定义**：单位时间内系统处理的数据量，通常以 MB/s 为单位。

```
计算方式：
吞吐量 = QPS × 平均消息大小

示例：
- QPS = 1000，平均消息大小 = 1KB
- 吞吐量 = 1000 × 1KB = 1 MB/s
```

### 2.2 系统资源术语

#### 2.2.1 POD

**定义**：Kubernetes 容器编排系统中的最小部署单元，可以理解为"一个独立运行的服务实例"。

> **通俗比喻**：如果把服务比作餐厅，每个 POD 就是一个厨师。POD 越多，能同时处理的订单就越多。

```
POD 配置示例：
- POD 数量：8 个
- 单个 POD CPU：8 核心
- 单个 POD 内存：8GB
```

#### 2.2.2 CPU 核心

**定义**：处理器的计算单元数量，核心数越多，并行处理能力越强。

```
评估方法：
- CPU 使用率 > 80%：可能需要扩容
- CPU 使用率 > 90%：高风险，建议立即扩容
```

#### 2.2.3 内存（Memory）

**定义**：用于存储运行时数据的空间，通常以 GB 为单位。

```
评估方法：
- 内存使用率 > 80%：可能需要扩容
- 内存使用率 > 90%：OOM（内存溢出）风险高
```

#### 2.2.4 OOM（Out Of Memory）

**定义**：内存耗尽。当程序使用的内存超过限制时，系统会强制杀死进程。

```
OOM 后果：
- 服务进程被杀死
- POD 重启
- 请求失败或超时
- 可能导致连锁故障
```

### 2.3 中间件术语

#### 2.3.1 Redis

**定义**：高性能的内存数据库，用于缓存数据，读写速度极快。

> **通俗比喻**：如果数据库是仓库，Redis 就是柜台。常用的东西放柜台上拿取更快，不用每次都跑去仓库。

```
Redis 特点：
- 数据存储在内存中
- 读写 QPS 可达 5万-10万/秒
- 支持数据过期自动删除
- 常用于缓存、计数器、分布式锁等场景
```

**关键指标**：
| 指标 | 说明 |
|------|------|
| 节点数量 | 集群中的 Redis 实例数 |
| 总内存 | 集群可用内存总量 |
| 内存使用率 | 已使用内存 / 总内存 |
| Redis QPS | 每秒 Redis 操作次数 |
| 命中率 | 缓存命中次数 / 总请求次数 |

#### 2.3.2 Kafka

**定义**：分布式消息队列系统，用于异步消息传递和流处理。

> **通俗比喻**：Kafka 就像邮局的信箱。生产者（Producer）把消息放进去，消费者（Consumer）从里面取出来处理。支持高并发，消息不会丢失。

```
Kafka 核心概念：
- Producer（生产者）：发送消息的一方
- Consumer（消费者）：接收消息的一方
- Topic（主题）：消息的分类，类似于邮箱地址
- Partition（分区）：Topic 的并行处理单元
- Retention Time（保留时间）：消息保存多久
```

**关键指标**：
| 指标 | 说明 |
|------|------|
| Producer TPS | 生产者每秒发送的消息量（MB/s）|
| Consumer TPS | 消费者每秒消费的消息量（MB/s）|
| Partition 数量 | 分区越多，并发能力越强 |
| Retention Time | 消息保留时间（小时）|
| Storage | 存储空间需求（GB）|

#### 2.3.3 Elasticsearch (ES)

**定义**：分布式搜索引擎，擅长处理复杂的搜索和分析查询。

> **通俗比喻**：如果数据库是图书馆的书架，ES 就是图书馆的检索系统，能快速找到你要的书。

```
ES 核心概念：
- Index（索引）：相当于数据库的"表"
- Document（文档）：相当于表中的"行"
- Query（查询）：搜索请求
```

**关键指标**：
| 指标 | 说明 |
|------|------|
| 集群节点数 | ES 集群中的服务器数量 |
| 集群总内存 | 可用内存总量 |
| ES QPS | 每秒查询次数 |
| 查询延迟 P95 | 95% 查询的响应时间 |
| 索引大小 | 数据占用的存储空间 |

#### 2.3.4 MySQL / 数据库

**定义**：关系型数据库，用于持久化存储业务数据。

```
数据库关键指标：
- DB QPS：每秒数据库查询次数
- 主库：处理写入操作
- 从库/备库：处理读取操作，分担主库压力
- 连接数：同时连接数据库的客户端数量
```

### 2.4 业务术语

#### 2.4.1 限流（Throttling）

**定义**：控制系统接收请求的速率，避免过载。

> **通俗比喻**：想象一个高速公路收费站，如果所有车辆同时涌入，道路会堵塞。限流就像是在入口设置闸机，控制每分钟只能通过多少车辆。

```
限流的作用：
- 保护系统不被过多请求压垮
- 保证核心业务的正常运行
- 对超出阈值的请求进行降级处理
```

#### 2.4.2 幂等（Idempotent）

**定义**：同一个操作执行一次和执行多次，结果是一样的。

```
幂等示例：
- 用户点击"提交订单"两次，系统只创建一个订单
- 同一个请求重试多次，只会产生一个结果
```

**为什么需要幂等**：
- 网络抖动导致请求重试
- 用户误操作多次点击
- 系统故障后的请求重放

#### 2.4.3 Mock

**定义**：模拟外部服务的返回结果，用于测试或压测。

```
Mock 的用途：
- 压测时不真实调用外部服务
- 避免压测影响外部系统
- 控制返回结果，便于测试各种场景
```

#### 2.4.4 缓存命中率

**定义**：请求在缓存中找到数据的比例。

```
计算公式：
命中率 = 缓存命中次数 / 总请求次数 × 100%

示例：
- 100 次请求中，90 次从缓存获取数据
- 命中率 = 90 / 100 × 100% = 90%

影响：
- 命中率高 → 数据库压力小 → 系统响应快
- 命中率低 → 数据库压力大 → 可能成为瓶颈
```

---

## 3. 协议知识

在进行压测之前，你需要了解被测接口使用的通信协议。不同协议有不同的特点和配置方式。

### 3.1 HTTP 协议

**HTTP（HyperText Transfer Protocol）** 是互联网上最常用的通信协议，用于客户端和服务器之间的数据传输。

#### 3.1.1 HTTP 核心概念

| 概念 | 说明 | 示例 |
|------|------|------|
| **URL** | 统一资源定位符，访问地址 | `https://api.shopee.com/order/create` |
| **Method** | 请求方法，表示操作类型 | GET（查询）、POST（创建）、PUT（更新）、DELETE（删除）|
| **Header** | 请求头，携带元数据信息 | `Content-Type: application/json` |
| **Body** | 请求体，携带业务数据 | `{"order_id": "123", "amount": 100}` |
| **Status Code** | 响应状态码，表示请求结果 | 200（成功）、400（参数错误）、500（服务器错误）|

#### 3.1.2 常见 Header 类型

| Header | 作用 | 常见值 |
|--------|------|--------|
| **Content-Type** | 声明请求体的数据格式 | `application/json`（JSON格式）<br>`application/x-www-form-urlencoded`（表单格式）<br>`multipart/form-data`（文件上传）|
| **Authorization** | 携带认证信息 | `Bearer token123`（Token认证）<br>`Basic xxx`（基础认证）|
| **Accept** | 声明期望的响应格式 | `application/json` |
| **User-Agent** | 客户端标识 | `Mozilla/5.0...` |

#### 3.1.3 HTTP 请求示例

```http
POST /api/order/create HTTP/1.1
Host: api.shopee.com
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "shop_id": 175361795,
  "order_id": "ORD123456",
  "country": "VN",
  "amount": 100.50
}
```

**请求解读**：
- `POST`：请求方法，表示创建资源
- `/api/order/create`：接口路径
- `Content-Type: application/json`：请求体是 JSON 格式
- 花括号内的内容：请求体（Body）

#### 3.1.4 HTTP 响应示例

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "code": 0,
  "message": "success",
  "data": {
    "order_id": "ORD123456",
    "status": "created"
  }
}
```

#### 3.1.5 常见状态码

| 状态码 | 含义 | 说明 |
|--------|------|------|
| **200** | OK | 请求成功 |
| **201** | Created | 资源创建成功 |
| **400** | Bad Request | 请求参数错误 |
| **401** | Unauthorized | 未授权，需要登录 |
| **403** | Forbidden | 禁止访问，权限不足 |
| **404** | Not Found | 资源不存在 |
| **429** | Too Many Requests | 请求过多，被限流 |
| **500** | Internal Server Error | 服务器内部错误 |
| **502** | Bad Gateway | 网关错误 |
| **503** | Service Unavailable | 服务不可用 |
| **504** | Gateway Timeout | 网关超时 |

### 3.2 gRPC 协议

**gRPC** 是 Google 开发的高性能远程过程调用（RPC）框架，常用于微服务之间的通信。

> **通俗理解**：HTTP 就像写信，格式灵活但效率一般；gRPC 像打电话，格式固定但效率更高。

#### 3.2.1 gRPC 核心概念

| 概念 | 说明 |
|------|------|
| **Proto 文件** | 接口定义文件，描述服务、方法和数据结构 |
| **Service** | 服务定义，包含多个可调用的方法 |
| **Method** | 具体的接口方法 |
| **Message** | 请求/响应的数据结构定义 |
| **Protobuf** | 二进制序列化格式，比 JSON 更小更快 |

#### 3.2.2 Proto 文件示例

```protobuf
// 文件：order.proto
syntax = "proto3";

package order;

// 定义服务
service OrderService {
  // 创建订单方法
  rpc CreateOrder(CreateOrderRequest) returns (CreateOrderResponse);
  // 查询订单方法
  rpc GetOrder(GetOrderRequest) returns (GetOrderResponse);
}

// 请求结构定义
message CreateOrderRequest {
  int64 shop_id = 1;      // 字段编号1
  string country = 2;     // 字段编号2
  double amount = 3;      // 字段编号3
}

// 响应结构定义
message CreateOrderResponse {
  string order_id = 1;
  int32 status = 2;
  string message = 3;
}

message GetOrderRequest {
  string order_id = 1;
}

message GetOrderResponse {
  string order_id = 1;
  int64 shop_id = 2;
  double amount = 3;
  int32 status = 4;
}
```

#### 3.2.3 gRPC vs HTTP 对比

| 特性 | HTTP/REST | gRPC |
|------|-----------|------|
| **数据格式** | JSON（文本） | Protobuf（二进制）|
| **传输效率** | 较低 | 高（数据更小）|
| **接口定义** | 文档描述 | Proto 文件强类型 |
| **开发门槛** | 低 | 较高（需要学习 Proto）|
| **浏览器支持** | 原生支持 | 需要特殊处理 |
| **适用场景** | 对外接口、Web 应用 | 微服务内部通信 |

#### 3.2.4 在压测中使用 gRPC

```
压测 gRPC 接口需要：
1. 获取 Proto 文件（包括依赖的 Proto 文件）
2. 上传到压测平台
3. 选择要压测的 Service 和 Method
4. 按照 Message 定义填写请求参数
```

### 3.3 SPEX 协议

**SPEX** 是 Shopee 内部的通信协议。

| 概念 | 说明 |
|------|------|
| **Command** | 类似 HTTP 的 URL，标识具体接口 |

> **注意**：SPEX 目前仅支持 test 环境压测。

### 3.4 JWT（JSON Web Token）

**JWT** 是一种用于身份认证的令牌格式，常用于接口鉴权。

#### 3.4.1 JWT 结构

```
JWT = Header.Payload.Signature

eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.    # Header（算法信息）
eyJ1c2VySWQiOiIxMjM0NTYiLCJleHAiOjE2...  # Payload（数据）
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV...    # Signature（签名）
```

#### 3.4.2 JWT 在压测中的应用

```
压测鉴权接口时需要：
1. 获取有效的 JWT Token
2. 在 Header 中携带：Authorization: Bearer <token>
3. 注意 Token 的过期时间
```

---

## 4. 网络基础知识

压测涉及大量网络通信，理解网络基础知识有助于排查问题。

### 4.1 Socket（套接字）

**定义**：Socket 是网络通信的端点，是应用程序与网络之间的接口。

> **通俗理解**：Socket 就像电话插座，程序通过它连接到网络，进行数据收发。

```
Socket = IP地址 + 端口号

示例：
- 192.168.1.1:8080
- 10.0.0.1:443
```

**在压测中的意义**：
- 每个并发连接都需要一个 Socket
- 操作系统的 Socket 数量有限（通常 65535 个端口）
- Socket 耗尽会导致 "Too many open files" 错误
- 高并发压测需要关注 Socket 使用情况

### 4.2 DNS（域名系统）

**定义**：DNS（Domain Name System）将域名转换为 IP 地址。

> **通俗理解**：DNS 就像电话簿，你输入名字（域名），它告诉你电话号码（IP地址）。

```
域名解析过程：
api.shopee.com  --DNS解析-->  10.0.0.1
    (域名)                     (IP地址)
```

**在压测中的意义**：
- DNS 解析也需要时间（几毫秒到几十毫秒）
- 大量请求可能导致 DNS 缓存失效
- 建议压测时直接使用 IP 地址，避免 DNS 延迟干扰
- DNS 服务本身也可能成为瓶颈

### 4.3 Ping 命令

**定义**：测试网络连通性的命令，检查能否到达目标主机。

```bash
# 测试能否连通 api.shopee.com
$ ping api.shopee.com

PING api.shopee.com (10.0.0.1): 56 data bytes
64 bytes from 10.0.0.1: icmp_seq=0 ttl=64 time=1.234 ms
64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=1.156 ms
64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=1.089 ms
^C
--- api.shopee.com ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 1.089/1.160/1.234/0.059 ms
```

**输出解读**：

| 指标 | 含义 |
|------|------|
| `time=1.234 ms` | 往返时间（RTT），网络延迟 |
| `ttl=64` | 生存时间，数据包经过的路由器数量 |
| `icmp_seq` | 序列号，用于统计丢包 |
| `packet loss` | 丢包率，0% 表示网络正常 |

**在压测中的用途**：
- 验证压测机器与目标服务的网络是否通畅
- 评估基础网络延迟
- 排查网络不通的问题

### 4.4 Telnet 命令

**定义**：测试端口连通性的命令，检查目标端口是否开放。

```bash
# 测试 api.shopee.com 的 80 端口是否开放
$ telnet api.shopee.com 80

Trying 10.0.0.1...
Connected to api.shopee.com.
Escape character is '^]'.

# 连接成功！按 Ctrl+] 然后输入 quit 退出
```

```bash
# 如果端口不通
$ telnet api.shopee.com 8888

Trying 10.0.0.1...
telnet: connect to address 10.0.0.1: Connection refused

# 连接被拒绝，端口未开放
```

**Ping vs Telnet 对比**：

| 命令 | 测试内容 | 用途 |
|------|---------|------|
| **Ping** | 网络层连通性（能否到达目标机器）| 检查网络是否通 |
| **Telnet** | 端口连通性（目标端口是否开放）| 检查服务是否正常监听 |

**在压测中的用途**：
- 验证目标服务端口是否正常监听
- 排查 "Connection refused" 错误
- 确认防火墙配置是否正确

### 4.5 客户端超时 vs 服务端超时

这是压测中非常重要的概念，理解两者的区别有助于排查超时问题。

#### 4.5.1 定义

| 类型 | 定义 | 设置位置 |
|------|------|---------|
| **客户端超时** | 客户端等待服务端响应的最长时间 | 调用方（压测工具）设置 |
| **服务端超时** | 服务端处理请求的最长时间 | 服务方设置 |

#### 4.5.2 工作流程

```
时间线：
0s                     3s                     5s
|----------------------|----------------------|
        服务端处理                客户端等待
      (服务端超时: 3s)         (客户端超时: 5s)

场景1：正常响应
[客户端] --请求--> [服务端] --处理2s--> [响应] --返回--> [客户端]
                                                        ✅ 成功

场景2：服务端超时
[客户端] --请求--> [服务端] --处理4s--> [服务端超时，返回错误]
                                        ❌ 服务端返回超时错误

场景3：客户端超时
[客户端] --请求--> [服务端] --处理中...-->
    |
    | 5s后客户端放弃等待
    ❌ 客户端超时，但服务端可能还在处理
```

#### 4.5.3 配置建议

```
关键原则：客户端超时 > 服务端超时

示例：
- 服务端超时：3s（处理请求最多3秒）
- 客户端超时：5s（等待响应最多5秒）

这样可以确保：
1. 服务端有足够时间处理请求
2. 服务端超时后能正常返回错误
3. 客户端能收到服务端的超时响应
```

#### 4.5.4 压测工具中的超时设置

在 Sparta 等压测工具中：
- **Timeout** 参数就是客户端超时
- 默认通常是 5 秒
- 应根据被测接口的实际情况调整

### 4.6 网络延迟与带宽

#### 4.6.1 网络延迟（Latency）

**定义**：数据从发送端到接收端所需的时间。

```
影响延迟的因素：
- 物理距离：跨国请求延迟更高
- 网络设备：路由器、交换机处理时间
- 网络拥堵：高峰期延迟增加
```

#### 4.6.2 带宽（Bandwidth）

**定义**：网络的最大数据传输能力，通常以 Mbps 或 Gbps 为单位。

```
带宽 vs 延迟：
- 带宽：水管的粗细（每秒能传多少数据）
- 延迟：水流的速度（数据传输需要多久）

即使带宽很大，延迟也可能很高
```

#### 4.6.3 在压测中的意义

```
注意事项：
1. 压测机器与服务器最好在同一机房，减少网络延迟
2. 大数据量压测需要关注带宽是否足够
3. 跨区域压测结果会包含网络延迟，需要单独评估
```

---

## 5. 压测前的资源评估

### 5.1 为什么要做资源评估

在压测之前，需要评估系统所需的各类资源，确保：
1. 压测环境配置合理
2. 了解系统当前容量
3. 制定合理的压测目标
4. 避免资源不足导致压测失败

### 5.2 资源评估维度

#### 5.2.1 Kafka Topic 评估

以实际项目为例，评估 Kafka 资源需求：

| 评估项 | 评估方式 | 示例值 |
|--------|---------|--------|
| 平均 QPS | 根据业务场景预估 | 500 次/秒 |
| 峰值 QPS | 平均 QPS × 倍数（如2-4倍）| 2000 次/秒 |
| 平均消息大小 | 根据消息结构估算 | 1.5 KB |
| 平均 TPS | 平均 QPS × 消息大小 | 0.75 MB/s |
| 峰值 TPS | 峰值 QPS × 消息大小 | 3 MB/s |
| 日消息量 | 平均 QPS × 86400 秒 | 4000 万条 |
| 日数据量 | 日消息量 × 消息大小 | 60 GB |

**配置需求计算**：
| 配置项 | 计算方式 | 建议值 |
|--------|---------|--------|
| Producer TPS | 峰值 TPS × 2（留余量）| 6 MB/s |
| Consumer TPS | 同 Producer TPS | 6 MB/s |
| Retention Time | 根据业务需求 | 72 小时（3天）|
| Storage | 日数据量 × 保留天数 | 200 GB |
| Partition 数量 | 根据吞吐量需求 | 3（每分区约 10MB/s）|

#### 5.2.2 Redis 评估

| 评估项 | 评估方式 | 示例值 |
|--------|---------|--------|
| 单 Key 大小 | 根据数据结构估算 | 200-400 bytes |
| Key 数量 | 根据业务场景估算 | 2 万个 |
| 过期时间 | 根据业务需求 | 7 天 |
| 存储大小 | Key大小 × 数量 × 过期时间 | 28 MB |
| 平均读写 QPS | 根据业务场景预估 | 500 次/秒 |
| 峰值读写 QPS | 平均 × 倍数 | 2000 次/秒 |

**配置需求计算**：
```
存储资源 = 估算值 × 安全系数（通常 2-3 倍）
QPS 需求 = 峰值 QPS × 安全系数

验证方式：
- 单机 Redis QPS 约 5万-10万/秒
- 集群实例数 × 单机 QPS > 峰值需求 QPS
```

### 5.3 数据刷入评估

压测需要准备足够的测试数据：

| 考虑因素 | 说明 |
|---------|------|
| **数据量** | 应接近或超过生产环境 |
| **数据分布** | 应与生产环境类似 |
| **数据关联** | 多表之间的关联关系要正确 |
| **数据覆盖** | 覆盖各种业务场景 |

**示例：测试数据量规划**
```
throttle_plan_tab：      1 万条（限流计划主表）
throttle_order_account：20 万条（每计划 20 个账户）
throttle_rule_tab：     20 万条（每计划 20 条规则）
throttle_shop_tab：    100 万条（每计划 100 个店铺）
```

---

## 6. 压测资源统计表详解

### 6.1 统计表的作用

压测资源统计表用于：
1. **建立性能基线**：记录 Live 环境在大促期间的真实资源使用情况
2. **评估压测环境**：对比 XX 压测环境与 Live 生产环境的差异
3. **制定扩容方案**：根据数据判断哪些资源需要扩容

### 6.2 统计表结构

一份完整的压测资源统计表应包含以下板块：

```
├── 📦 POD 资源（服务实例）
│   ├── 服务A（如 checkout-service）
│   ├── 服务B（如 network-route-service）
│   └── 服务C（如 smart-sorting-service）
│
├── 🔴 中间件 - Redis/Codis（缓存）
│
├── 🟠 中间件 - Kafka（消息队列）
│
├── 🔵 中间件 - ES（Elasticsearch）
│
└── 💾 数据库（MySQL）
```

### 6.3 POD 资源统计项

| 资源项 | 说明 | 用途 | 优先级 |
|--------|------|------|--------|
| POD 数量 | 服务实例数量 | 计算单 POD 处理能力 | ✅ 必需 |
| 单个 POD CPU | 每 POD 分配的 CPU 核心数 | 评估 CPU 容量 | ✅ 必需 |
| 单个 POD 内存 | 每 POD 分配的内存大小 | 评估内存容量 | ✅ 必需 |
| 当时 QPS | 大促期间的请求量 | 计算单 POD 处理能力 | ✅ 必需 |
| 当时 RT P95 | 95% 请求的响应时间 | 建立性能基线 | ✅ 必需 |
| 当时 RT P99 | 99% 请求的响应时间 | 评估极端情况 | ⚠️ 建议 |
| 压测接口 QPS | 要压测的接口的请求量 | 计算接口占比 | ✅ 必需 |
| 压测接口 CPU 占比 | 压测接口 CPU 使用 / 总 CPU | 评估影响范围 | ⚠️ 建议 |
| 压测接口 DB QPS 占比 | 压测接口 DB QPS / 总 DB QPS | 评估 DB 压力 | ✅ 必需 |

### 6.4 Redis 资源统计项

| 资源项 | 说明 | 用途 | 优先级 |
|--------|------|------|--------|
| 节点数量 | Redis 集群节点数 | 评估集群容量 | ✅ 必需 |
| 总内存 | 集群内存总量 | 评估内存容量 | ✅ 必需 |
| 内存使用率 | 已用内存 / 总内存 | 判断是否需扩容 | ⚠️ 建议 |
| 总 Redis QPS | 所有业务的 Redis QPS | 评估 Redis 负载 | ✅ 必需 |
| 压测接口 Redis QPS | 压测接口的 Redis QPS | 评估影响范围 | ✅ 必需 |
| Redis QPS 占比 | 压测接口 / 总 QPS | 评估影响程度 | ✅ 必需 |
| 缓存命中率 | 命中次数 / 总请求 | 评估缓存效果 | ⚠️ 建议 |
| 当前延迟 P95 | 95% 请求的延迟 | 评估 Redis 性能 | ⚠️ 建议 |

### 6.5 ES 资源统计项

| 资源项 | 说明 | 用途 | 优先级 |
|--------|------|------|--------|
| ES 集群节点数 | 集群服务器数量 | 评估集群容量 | ✅ 必需 |
| ES 集群总内存 | 可用内存总量 | 评估内存容量 | ✅ 必需 |
| 总 ES QPS | 所有业务的 ES 查询量 | 评估 ES 负载 | ✅ 必需 |
| 压测接口 ES QPS | 压测接口的 ES 查询量 | 评估影响范围 | ✅ 必需 |
| ES 查询延迟 P95 | 95% 查询的响应时间 | 评估查询性能 | ✅ 必需 |
| 索引名称 | ES 索引名 | 确认配置 | ✅ 必需 |
| 索引结构配置 | 索引字段和设置 | 必须与 Live 一致 | ✅ 必需 |
| 数据量比例 | XX 环境 / Live 环境 | 建议 ≥50% | ✅ 必需 |

### 6.6 核心计算公式

```
单 POD 处理能力 = 当时 QPS / POD 数量
示例：2000 QPS / 8 POD = 250 QPS/POD

扩容估算：
如果要扛住 4000 QPS，需要多少 POD？
4000 / 250 = 16 个 POD

接口占比计算：
压测接口 QPS 占比 = 压测接口 QPS / 总 QPS × 100%
示例：2000 / 25000 × 100% = 8%

影响评估：
如果压测接口只占 8%，即使接口 QPS 翻倍，
对整体系统的影响也是有限的。
```

---

## 7. 压测实施流程

### 7.1 压测准备阶段

#### 7.1.1 资源准备清单

| 资源类型 | 重要程度 | 准备内容 |
|---------|---------|---------|
| MySQL | ⭐⭐⭐⭐⭐ | 专用压测数据库，与生产隔离 |
| Redis | ⭐⭐⭐⭐⭐ | 压测专用集群 |
| Kafka | ⭐ | 压测专用集群（非核心可复用）|
| 外部依赖 | ⭐⭐⭐⭐ | Mock 外部服务调用 |

#### 7.1.2 代码改造

```go
// Mock 外部服务调用示例

// Mock Network 服务返回固定数据
func BuildMockNetworkPathInfo(...) *define.NetworkPathInfo {
    return &define.NetworkPathInfo{
        Origin: define.Path{...},
        Dest:   define.Path{...},
    }
}

// Mock Basic 服务返回固定数据
func BuildMockShopInfo() (*basic_shop.GetShopSpecifyInfoData, error) {
    return &basic_shop.GetShopSpecifyInfoData{
        ThrottlingToggle: true,
    }, nil
}
```

#### 7.1.3 配置检查

- [ ] Apollo 配置指向压测集群（**切忌指向 Live！**）
- [ ] 数据库连接配置正确
- [ ] Redis 集群配置正确
- [ ] Kafka 配置正确
- [ ] 外部服务 Mock 开启

### 7.2 压测执行阶段

#### 7.2.1 阶段一：预热

**目的**：避免冷启动导致的假高 RT。

```
配置：
- connections: 20
- duration: 1-2 分钟

观察点：
- 是否有异常 RT
- 服务是否正常响应
- 日志是否有异常
```

> **什么是冷启动？**
> 服务刚启动时，缓存未预热、JIT 编译未完成、连接池未填充，性能会比较差。预热阶段让系统进入正常工作状态。

#### 7.2.2 阶段二：线性增压

**目的**：逐步增加压力，找到系统瓶颈。

| 阶段 | 并发连接数 | 持续时间 | 预计 QPS |
|------|-----------|---------|----------|
| Stage1 | 50 | 1 分钟 | ~500 |
| Stage2 | 100 | 1 分钟 | ~1000 |
| Stage3 | 150 | 1 分钟 | ~1500 |
| Stage4 | 180 | 1 分钟 | ~1800 |
| Stage5 | 200 | 1 分钟 | ~2000 |

**观察指标**：
- QPS 是否线性上升
- P99 是否正常（如 < 500ms）
- 无 error（超时 / 429 / 500 等）
- CPU、内存使用是否正常

#### 7.2.3 阶段三：稳定压测

**目的**：验证系统能否稳定承受目标 QPS。

```
配置：
- connections: 200-230（根据增压阶段结果调整）
- duration: 10 分钟

验证点：
- [ ] QPS 整段维持在目标值
- [ ] RT 稳定（P99 无明显抖动）
- [ ] Error rate = 0%
- [ ] CPU、Redis、MySQL 不爆
- [ ] POD 不重启、不 OOM
```

**稳定通过 = 接口能扛住目标 QPS**

### 7.3 压测结果记录

#### 7.3.1 结果记录模板

| 压测场景 | Failed | Success | QPS | MIN | AVG | MAX | P50 | P90 | P95 | P99 |
|---------|--------|---------|-----|-----|-----|-----|-----|-----|-----|-----|
| 预热阶段 | 0 | 2000 | 100 | 50ms | 80ms | 200ms | 70ms | 100ms | 120ms | 180ms |
| Stage1 | 0 | 30000 | 500 | 45ms | 90ms | 300ms | 80ms | 120ms | 150ms | 250ms |
| Stage2 | 0 | 60000 | 1000 | 50ms | 100ms | 400ms | 90ms | 150ms | 200ms | 350ms |
| 稳定压测 | 0 | 1200000 | 2000 | 55ms | 110ms | 500ms | 100ms | 180ms | 250ms | 400ms |

#### 7.3.2 资源监控记录

| 指标 | 压测前 | 压测中峰值 | 压测后 |
|------|--------|-----------|--------|
| CPU 使用率 | 20% | 75% | 22% |
| 内存使用率 | 45% | 68% | 46% |
| Redis QPS | 500 | 3000 | 520 |
| DB QPS | 100 | 800 | 110 |

---

## 8. 压测结果分析

### 8.1 判断标准

#### 8.1.1 性能达标标准

| 指标 | 达标标准 | 说明 |
|------|---------|------|
| Error Rate | 0% | 无请求失败 |
| P95 | < 目标值（如 500ms）| 95% 请求响应正常 |
| P99 | < 目标值（如 1s）| 极端情况可接受 |
| QPS | ≥ 目标值 | 达到预期处理能力 |

#### 8.1.2 资源健康标准

| 指标 | 健康标准 | 警告标准 | 危险标准 |
|------|---------|---------|---------|
| CPU 使用率 | < 70% | 70-85% | > 85% |
| 内存使用率 | < 70% | 70-85% | > 85% |
| Redis 连接数 | < 80% | 80-90% | > 90% |
| DB 连接数 | < 80% | 80-90% | > 90% |

### 8.2 问题诊断

#### 8.2.1 常见问题及原因

| 现象 | 可能原因 | 排查方向 |
|------|---------|---------|
| QPS 上不去 | CPU 瓶颈 | 检查 CPU 使用率 |
| RT 抖动大 | 垃圾回收 | 检查 GC 日志 |
| P99 很高 | 慢查询 | 检查 DB 慢查询日志 |
| 请求超时 | 连接池耗尽 | 检查连接池配置 |
| Error 增多 | 资源耗尽 | 检查内存、连接数 |

#### 8.2.2 瓶颈定位方法

```
排查顺序：
1. 检查 POD 资源（CPU、内存）
2. 检查 Redis（QPS、延迟、连接数）
3. 检查数据库（QPS、慢查询、连接数）
4. 检查 Kafka（延迟、积压）
5. 检查网络（带宽、延迟）
```

### 8.3 优化建议

| 瓶颈类型 | 优化方案 |
|---------|---------|
| CPU 不足 | 增加 POD 数量或单 POD CPU |
| 内存不足 | 增加 POD 内存或优化内存使用 |
| Redis 瓶颈 | 增加节点或优化数据结构 |
| DB 瓶颈 | 增加从库、优化查询、增加缓存 |
| 连接池不足 | 增加连接池大小 |

---

## 9. Sparta 压测工具使用

Sparta 是 Shopee 内部的在线压测平台，支持 HTTP、gRPC、SPEX 三种协议的压测。

### 9.1 制作压测用例

压测用例只描述**业务场景**（接口信息、参数、断言等），不包含压测地址和并发配置。

#### 9.1.1 选择协议类型

| 协议 | 说明 | 配置方式 |
|------|------|---------|
| **HTTP** | 最常用的 Web 协议 | 手动输入 URL 和参数 |
| **gRPC** | 高性能 RPC 协议 | 上传 Proto 文件后选择 Method |
| **SPEX** | Shopee 内部协议 | 手动输入 Command（仅 test 环境）|

#### 9.1.2 gRPC 协议配置

```
配置步骤：
1. 上传 Proto 文件（包括所有依赖的 Proto 文件）
2. 等待平台自动解析
3. 选择要压测的 Service 和 Method
4. 按照 Message 定义填写请求参数
```

### 9.2 参数化配置

参数化允许你在请求中使用动态值，避免重复请求相同数据。

#### 9.2.1 参数化格式

使用 **双花括号** `{{}}` 标记参数：

```json
{
    "header": {
        "seq_id": "{{__Time(\"ms\")}}",
        "caller_id": 100402
    },
    "shop_id": 175361795,
    "order_id": "{{__Csv(\"orders.order_id\")}}",
    "country": "VN"
}
```

#### 9.2.2 可参数化的范围

| 协议 | 可参数化部分 |
|------|-------------|
| HTTP | Header 和 Body |
| gRPC | Body |
| SPEX | Body |

### 9.3 内置参数化函数

#### 9.3.1 CSV 文件函数

从 CSV 文件读取数据，支持循环使用。

```
格式：{{__Csv("FileName.FieldName")}}

示例 CSV 文件（orders.csv）：
order_id,shop_id,amount
ORD001,12345,100
ORD002,12346,200

使用方式：
- 指定文件：{{__Csv("orders.order_id")}}
- 省略文件名（仅一个CSV时）：{{__Csv("order_id")}}

注意：
- CSV 文件必须是无 BOM 格式的 UTF-8 编码
- 请求数超过行数时会循环使用数据
```

#### 9.3.2 时间函数

生成时间戳或格式化时间。

```
格式：{{__Time("format")}}

示例：
- 秒时间戳：{{__Time("s")}}        → 1704067200
- 毫秒时间戳：{{__Time("ms")}}     → 1704067200000
- 格式化时间：{{__Time("2006-01-02 15:04:05")}} → 2024-01-01 00:00:00

注意：Go 语言的时间格式使用固定的参考时间 "2006-01-02 15:04:05"
```

#### 9.3.3 随机数函数

生成指定范围内的随机数。

```
格式：{{__Random(start, end)}}

示例：
- {{__Random(1000, 9999)}} → 随机返回 1000 到 9999 之间的整数
- {{__Random(1, 100)}}     → 随机返回 1 到 100 之间的整数
```

#### 9.3.4 递增数函数

生成递增序列，到达终点后循环。

```
格式：{{__Range(start, end)}}

示例：
- {{__Range(1, 1000)}} → 依次返回 1, 2, 3, ..., 1000, 1, 2, 3, ...
```

#### 9.3.5 正则表达式函数

根据正则表达式生成随机字符串。

```
格式：{{__RegularEx("regex")}}

示例：
- {{__RegularEx("[0-9]{3}")}}     → 随机生成 3 位数字，如 "123"
- {{__RegularEx("[a-z]{5}")}}     → 随机生成 5 位小写字母
- {{__RegularEx("ORD[0-9]{6}")}}  → 生成如 "ORD123456" 的字符串
```

#### 9.3.6 上下文变量

从前序请求的响应中提取变量，用于后续请求。

```
提取变量（在前序请求的"参数提取"中配置）：
{"$.data.order_id": "orderId"}

使用变量（在后续请求中）：
{"order_id": "{{orderId}}"}
```

### 9.4 断言配置

断言用于验证响应是否符合预期。

#### 9.4.1 JSON 断言格式

```json
{
    "$.resp_header.retcode": 0,
    "$.data.status": "success",
    "$.data.items[0].id": 12345
}
```

#### 9.4.2 JSONPath 语法

| 表达式 | 含义 |
|--------|------|
| `$` | 根节点 |
| `.field` | 获取字段 |
| `[0]` | 获取数组第一个元素 |
| `[*]` | 获取数组所有元素 |
| `$.data.items[0].id` | 获取嵌套字段 |

### 9.5 创建压测任务

用例创建完成后，需要创建关联的压测任务来执行压测。

#### 9.5.1 任务配置项

| 配置项 | 说明 | 示例 |
|--------|------|------|
| **Connections** | 并发连接数 | 100（100个并发）|
| **Duration** | 压测时长（秒）| 60（压测60秒）|
| **Timeout** | 请求超时时间（秒）| 5（默认5秒）|
| **Error Percent** | 错误率阈值（%）| 1（>1%自动停止）|
| **Address** | 被测服务地址 | http://api.test.com |

#### 9.5.2 高级配置

| 配置项 | 说明 | 使用场景 |
|--------|------|---------|
| **Request Ratio** | 请求比例（如 1:2:3）| 多接口按比例分配请求 |
| **Transaction** | 事务模式 | 接口串行执行，前序失败则跳过后续 |

#### 9.5.3 执行流程

```
1. 创建任务并配置参数
2. 点击 Debug 验证请求是否正确
3. 确认无误后点击 Execute 开始压测
4. 实时观察压测结果
5. 压测完成后查看报告
```

### 9.6 压测报告解读

#### 9.6.1 报告状态

| 状态 | 含义 | 判断标准 |
|------|------|---------|
| **Pass** | 通过 | 成功率>99%，响应时间偏差在可接受范围 |
| **Request Failed** | 请求失败 | 成功率<99% |
| **Over Percent** | 超出阈值 | 成功率>99%，但响应时间偏差>30% |
| **Failed** | 执行失败 | 执行过程中出错 |
| **Inner Failed** | 内部错误 | 平台或第三方服务错误 |
| **Stop** | 手动停止 | 用户主动停止 |
| **Time out** | 超时 | 执行时间过长 |

#### 9.6.2 Pass 的具体标准

```
必须同时满足以下条件：
- 请求成功率 > 99%
- 平均响应时间与基线差 < 15%
- P50 响应时间与基线差 < 10%
- P90 响应时间与基线差 < 20%
- P95 响应时间与基线差 < 30%
```

### 9.7 前置步骤

前置步骤用于在压测开始前执行准备工作。

#### 9.7.1 使用场景

- 开启配置开关
- 修改数据库状态
- 准备测试数据
- 生成动态 CSV 文件

#### 9.7.2 执行模式

| 模式 | 说明 | 超时时间 |
|------|------|---------|
| **同步模式** | 等待响应后继续 | 15 秒 |
| **异步模式** | 等待回调后继续 | 10 分钟 |

```
同步模式适用：
- 简单的配置开关开启
- 快速的数据库修改
- 无需回传数据

异步模式适用：
- 需要修改 CSV 文件
- 复杂的数据准备操作
- 需要较长处理时间
```

---

## 10. 常见问题与注意事项

### 10.1 压测前注意事项

| 注意事项 | 说明 |
|---------|------|
| ⚠️ 隔离环境 | 绝对不能压测生产环境！ |
| ⚠️ 配置检查 | 仔细检查所有配置指向压测集群 |
| ⚠️ 数据准备 | 确保测试数据量足够且分布合理 |
| ⚠️ Mock 外部服务 | 避免压测影响外部系统 |
| ⚠️ 通知相关方 | 知会 DBA、运维等相关人员 |

### 10.2 压测中注意事项

| 注意事项 | 说明 |
|---------|------|
| 👀 实时监控 | 密切关注各项指标变化 |
| 📊 记录数据 | 及时记录各阶段的数据 |
| 🔄 循序渐进 | 从低压力逐步增加，不要一步到位 |
| 🛑 及时止损 | 发现异常立即停止压测 |

### 10.3 压测后注意事项

| 注意事项 | 说明 |
|---------|------|
| 📝 输出报告 | 整理压测数据，输出压测报告 |
| 🔍 问题复盘 | 分析发现的问题，提出优化方案 |
| 🧹 环境清理 | 清理测试数据，释放资源 |
| 📋 归档记录 | 保存压测配置和结果，便于后续参考 |

### 10.4 常见误区

| 误区 | 正确做法 |
|------|---------|
| 只看平均值 | 重点关注 P95/P99 |
| 数据量不足 | 测试数据应接近生产环境 |
| 忽略预热 | 必须有预热阶段 |
| 压力太大太快 | 循序渐进增加压力 |
| 只关注接口 | 同时关注资源使用情况 |

---

## 11. 附录：核心公式速查

### 11.1 QPS 相关

```
QPS = 并发连接数 × (1 / RT秒)
QPS = 成功请求数 / 测试时长(秒)

示例：
100 并发 × (1 / 0.1秒) = 1000 QPS
```

### 11.2 容量规划

```
单 POD 处理能力 = 总 QPS / POD 数量
所需 POD 数 = 目标 QPS / 单 POD 处理能力

示例：
单 POD 能力 = 2000 / 8 = 250 QPS/POD
扛 4000 QPS 需要 = 4000 / 250 = 16 POD
```

### 11.3 吞吐量

```
吞吐量(MB/s) = QPS × 平均消息大小(MB)

示例：
1000 QPS × 0.001 MB = 1 MB/s
```

### 11.4 占比计算

```
接口 QPS 占比 = 接口 QPS / 总 QPS × 100%
资源占比 = 接口资源使用 / 总资源使用 × 100%

示例：
2000 / 25000 × 100% = 8%
```

### 11.5 缓存命中率

```
命中率 = 缓存命中次数 / 总请求次数 × 100%

示例：
900 次命中 / 1000 次请求 × 100% = 90%
```

### 11.6 内存估算

```
总内存需求 = 单 Key 大小 × Key 数量 × 保留天数

示例：
200 bytes × 20000 × 7 天 = 28 MB
```

---

## 📚 学习建议

### 学习路径

作为新人 QA，建议按以下顺序学习：

```
阶段1：理论基础（1-2天）
├── 熟悉核心术语：QPS、RT、P95/P99
├── 理解协议知识：HTTP、gRPC 基础
└── 掌握网络基础：Ping、Telnet、超时概念

阶段2：工具学习（1-2天）
├── 熟悉 Sparta 压测平台
├── 学会制作压测用例
└── 掌握参数化和断言配置

阶段3：观摩实践（1周）
├── 观察老同事执行压测
├── 学会看监控工具（Grafana、CAT）
└── 理解资源统计表的作用

阶段4：独立实践（1-2周）
├── 在指导下完成第一次压测
├── 学会分析压测结果
└── 掌握问题排查方法

阶段5：进阶提升（持续）
├── 深入理解系统架构
├── 掌握性能优化方法
└── 总结复盘每次压测经验
```

### 学习资源

| 资源 | 说明 |
|------|------|
| 本文档 | 压测核心知识速查 |
| Sparta 官方文档 | 压测工具详细使用说明 |
| Grafana | 监控数据可视化 |
| CAT | 调用链监控和分析 |

### 实践建议

1. **多动手**：理论结合实践，多在测试环境尝试
2. **多提问**：遇到不懂的及时请教同事
3. **做笔记**：记录遇到的问题和解决方案
4. **复盘总结**：每次压测后总结经验教训

---

## 📋 知识点速查表

| 类别 | 知识点 | 章节 |
|------|--------|------|
| 基础概念 | QPS、RT、P95/P99 | 第2章 |
| 系统资源 | POD、CPU、内存、OOM | 第2章 |
| 中间件 | Redis、Kafka、ES | 第2章 |
| 协议知识 | HTTP、gRPC、JWT | 第3章 |
| 网络基础 | Socket、DNS、Ping、Telnet | 第4章 |
| 资源评估 | Kafka、Redis 评估方法 | 第5章 |
| 统计表 | POD、Redis、ES 资源统计 | 第6章 |
| 压测流程 | 预热、增压、稳定压测 | 第7章 |
| 结果分析 | 判断标准、问题诊断 | 第8章 |
| Sparta工具 | 用例、参数化、断言、任务 | 第9章 |
| 注意事项 | 压测前中后注意事项 | 第10章 |
| 公式速查 | QPS、容量、吞吐量公式 | 第11章 |
| 实战案例 | Throttle接口全链路调用详解 | 第12章 |
| 监控指标 | MySQL/Redis监控面板详解 | 第13章 |
| 统计模板 | 压测指标统计表模板 | 第14章 |

---

---

## 12. 实战案例：Throttle接口压测方案详解

本章节基于实际的Throttle（限流）接口压测方案，详细讲解压测的完整链路、调用关系和中间件使用。

### 12.1 压测背景与目标

#### 12.1.1 压测接口

| 项目 | 说明 |
|------|------|
| **入口接口** | `api/checkout/throttle/calculate` |
| **功能** | 计算订单限流方案，决定是否需要延迟发货 |
| **协议** | HTTP |
| **目标QPS** | 6850（线上3.4倍） |

#### 12.1.2 压测QPS阶段

| 阶段 | 目标QPS | 相对线上 | 持续时间 | 观察重点 |
|------|---------|---------|---------|---------|
| 1 | 1,000 | 0.5× | 5 min | 基础响应时间、链路是否正常 |
| 2 | 1,500 | 0.75× | 5 min | 资源使用是否线性 |
| 3 | 2,000 | 1.0× | 10 min | 是否和线上表现一致 |
| 4 | 2,500 | 1.25× | 10 min | RT是否开始抬头 |
| 5 | 3,000 | 1.5× | 10 min | CPU/数据库压力 |
| 6 | 4,000 | 2.0× | 15 min | GC、连接池使用情况 |
| 7 | 5,000 | 2.5× | 15 min | 是否出现非线性退化 |
| 8 | 6,000 | 3.0× | 15 min | 错误率、请求超时情况 |
| 9 | 6,850 | 3.4× | 20 min | 是否满足目标容量 |

### 12.2 完整调用链路

#### 12.2.1 链路总览

```
用户下单
    │
    ▼ HTTP
┌─────────────────────────────────────────────────────────────────────┐
│  FO (Frontend)                                                      │
│  HTTP请求 → api/checkout/throttle/calculate                          │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼ HTTP
┌─────────────────────────────────────────────────────────────────────┐
│  Checkout Service                                                   │
│  ┌─────────────────┐                                                │
│  │ LocalCache      │ ← 限流配置缓存(6张表)                             │
│  │ MySQL主库        │ ← 缓存刷新时查询                                 │
│  │ Redis           │ ← 多实例缓存同步信号                              │
│  └─────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼ gRPC
┌─────────────────────────────────────────────────────────────────────┐
│  Network Service (CalculateVolumeThrottleSolution)                  │
│  ┌─────────────────┐                                                │
│  │ 缓存             │ ← 站点网络规划缓存                               │
│  │ MySQL从库        │ ← site_solution_tab等                          │
│  └─────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────┘
    │                          │
    ▼ gRPC                     ▼ gRPC
┌───────────────────┐    ┌─────────────────────────────────────────────┐
│  Pickup Service   │    │  Smart Sorting Service                      │
│  ┌─────────────┐  │    │  ┌─────────────┐  ┌─────────────────────┐   │
│  │MySQL从库     │  │    │  │MatchZone    │  │MatchPickupHubZoneV2 │   │
│  │ pickup_     │  │    │  └─────────────┘  └─────────────────────┘   │
│  │ point_tab   │  │    │  ┌─────────────────────────────────────┐    │
│  │(每次必查)    │  │    │  │ Redis: 区域映射/Division白名单         │    │
│  ├─────────────┤  │    │  │ LocalCache：区域集合/Station白名单     │    │
│  │Redis        │  │    │  │ MySQL从库: 多张表                     │    │
│  │ PUP白名单    │  │    │  │ ES: 区域搜索(仅MatchPickupHubZoneV2)  │    │
│  ├─────────────┤  │    │  │ Kafka：异步落库                       │    │
│  │MySQL从库     │  │    │  └─────────────────────────────────────┘    │
│  │ pup_white_  │  │    └─────────────────────────────────────────────┘
│  │ list_record │  │                        │
│  └─────────────┘  │                        ▼ gRPC (可选)
└───────────────────┘    ┌─────────────────────────────────────────────┐
                         │  Address Service (PMS)                      │
                         │  ┌─────────────────────────────────────┐    │
                         │  │ MySQL从库：geometry_hash_manager_tab │    │
                         │  └─────────────────────────────────────┘    │
                         └─────────────────────────────────────────────┘
```

#### 12.2.2 调用方式说明

| 调用关系 | 调用方式 | 说明 |
|---------|---------|------|
| FO → Checkout | HTTP | 前端发起的HTTP请求 |
| Checkout → Network | gRPC | 跨服务RPC调用 |
| Network → Pickup | gRPC | 跨服务RPC调用 |
| Network → Smart Sorting | gRPC | 跨服务RPC调用 |
| Smart Sorting → Address | gRPC | 可选调用，根据配置决定 |

### 12.3 各服务详细说明

#### 12.3.1 Checkout Service

**入口接口**：`api/checkout/throttle/calculate`

**作用**：
- 接收前端请求，解析参数
- 判断订单是否需要限流（节流）
- 根据限流规则计算延迟时间

**中间件使用**：

| 中间件 | 用途 | 数据表/Key | 说明 |
|--------|------|-----------|------|
| **LocalCache** | 缓存限流配置 | 6张配置表的数据 | 启动时加载，定期刷新 |
| **MySQL主库** | 刷新限流配置 | `throttle_plan_tab`等 | 缓存无效时查询 |
| **Redis** | 缓存刷新信号 | `{cid}::throttle::plan::version` | 多实例间同步 |

**涉及的数据表**：
- `throttle_plan_tab` - 限流计划表
- `throttle_effective_time_tab` - 生效时间表
- `throttle_rule_tab` - 限流规则表
- `throttle_threshold_tab` - 阈值配置表
- `throttle_shop_tab` - 店铺关联表
- `throttle_order_account_tab` - 订单账户关联表

**缓存刷新机制**：
- 启动时立即加载一次
- 每5分钟检查Redis刷新信号
- 每30分钟强制刷新一次

#### 12.3.2 Network Service（内部模块）

**方法**：`CalculateVolumeThrottleSolution`

**作用**：
- 根据Origin/Dest地址，计算物流网络路径
- 确定取件站点、配送站点、途经站点

**子流程**：
```
CalculateVolumeThrottleSolution
    ├─> calculateVolumeThrottlePickupSolution  → 计算取件方案
    ├─> calculateVolumeThrottleDeliverySolution → 计算配送方案
    └─> calculateVolumeThrottleDeliveryPath     → 计算配送路径
```

**中间件使用**：

| 中间件 | 用途 | 数据表 |
|--------|------|-------|
| **缓存** | 站点网络规划缓存 | - |
| **MySQL从库** | 站点方案查询 | `site_solution_tab`、`site_solution_version_tab` |

#### 12.3.3 Pickup Service（gRPC）

**方法**：`GetPickupPointByAddressInfo`

**作用**：
- 根据卖家店铺地址，查找对应的取件点(PUP)
- 卖家店铺地址 → 取件点 → 取件站点

**子流程**：
```
GetPickupPointByAddressInfo
    ├─> FindPickupPointByShopAddress
    │   └─> 根据地址checksum查询pickup_point_tab
    │
    └─> GetPupWhiteListStationIdByPickupPointIdWithCache
        └─> 查询该PUP是否有白名单站点
```

**中间件使用**：

| 中间件 | 用途 | 数据表/Key | 缓存策略 |
|--------|------|-----------|---------|
| **MySQL从库** | 查询PUP信息 | `pickup_point_tab` | **每次必查，无缓存** |
| **Redis** | PUP白名单缓存 | `pup_level_white_list_station_id_{pickupPointId}` | 命中率20-80% |
| **MySQL从库** | 白名单回源 | `pup_white_list_record_tab` | Redis未命中时查询 |

#### 12.3.4 Smart Sorting Service（gRPC）

提供两个接口：

##### MatchZone（最后一公里区域匹配）

**作用**：根据收件人地址，匹配配送区域和配送站点

**处理步骤**：
```
MatchZone
    ├─> Step1: GetMappedResult     → 行政区域映射（省市区标准化）
    ├─> Step2: AsyncMatchZone      → 地址匹配（解析地址）
    ├─> Step3: HybridV2            → 策略融合（多策略结果合并）
    ├─> Step4: SearchZones         → 区域搜索（找到覆盖该点的zone）
    ├─> Step5: matchGeoDriverZone  → Geo兜底（白名单检查）
    ├─> Step6: finalMatchHotspot   → Hotspot匹配（白名单检查）
    └─> Step7: saveMatchRecord     → 异步落库（Kafka）
```

**特点**：线上**不使用ES**，只用DB查询`admin_zone_index_tab`

##### MatchPickupHubZoneV2（取件Hub区域匹配）

**作用**：根据卖家地址，匹配取件Hub区域

**处理步骤**：
```
MatchPickupHubZoneV2
    ├─> Step1: locationAddress      → 地址处理+行政区域映射
    ├─> Step2: matchZone            → 区域匹配
    │   ├─> SearchZoneByPoint       → 区域搜索（ES/DB）
    │   ├─> ListZoneCellDetail      → 区域详情（每次必查，无缓存）
    │   └─> matchZoneGuaranty       → 兜底匹配（白名单检查）
    ├─> Step3: matchHubZoneHybrid   → 策略融合
    └─> Step4: saveMatchRecord      → 异步落库（Kafka）
```

**特点**：**当前主用ES**查询，后续会切到DB

**Smart Sorting中间件使用汇总**：

| 中间件 | 用途 | 数据表/Key | 缓存策略 |
|--------|------|-----------|---------|
| **Redis** | 行政区域映射缓存 | `division_mapping_{hash}_{zipcode}_{level}_{version}` | 命中率20-80% |
| **MySQL从库** | 区域映射回源 | `division_mapping_tab` | Redis未命中时查询 |
| **LocalCache** | 区域集合缓存 | `zone_collection_{business_key}_{business_type}` | 命中率80-90% |
| **MySQL从库** | 区域集合回源 | `zone_collection_tab`, `zone_version_tab` | LocalCache未命中时查询 |
| **MySQL从库** | 区域索引查询 | `admin_zone_index_tab` | MatchZone主用DB |
| **Elasticsearch** | 区域搜索 | `admin_zone_index_*` | 仅MatchPickupHubZoneV2当前使用 |
| **MySQL从库** | 区域详情查询 | `zone_cell_tab` | **每次必查，无缓存**（性能瓶颈点） |
| **LocalCache** | Station白名单缓存 | `station_white_list_{business_type}_{station_id}` | 命中率80-90% |
| **MySQL从库** | Station白名单回源 | `hub_whitelist_tab` | LocalCache未命中时查询 |
| **Redis** | Division白名单缓存 | `division_whitelist` | 命中率20-80% |
| **MySQL从库** | Division白名单回源 | `conf_whitelist_division_tab` | Redis未命中时查询 |
| **Kafka** | 异步落库 | Topic: `match_feedback_{env}` | 不阻塞主流程 |

#### 12.3.5 Address Service / PMS（gRPC，可选）

**方法**：`BatchMatchGeometryByPoints`

**作用**：
- 根据经纬度坐标，批量匹配几何多边形区域
- 是SmartSorting区域搜索的一种可选方式

**中间件使用**：

| 中间件 | 用途 | 数据表 |
|--------|------|-------|
| **MySQL从库** | 几何区域查询 | `geometry_hash_manager_tab` |

### 12.4 性能瓶颈点

| 位置 | 瓶颈原因 | 优化建议 |
|------|---------|---------|
| `pickup_point_tab` | 每次必查，无缓存 | 监控查询延迟，优化索引 |
| `zone_cell_tab` | 每次必查，无缓存 | 监控查询延迟，考虑添加缓存 |
| 白名单查询 | 每个流量都查Station+Division两种 | 确保缓存命中率 |
| ES查询 | MatchPickupHubZoneV2当前主用ES | 监控ES集群健康状态 |

### 12.5 数据表汇总

| 表名 | 服务 | 查询条件 | 缓存策略 | 备注 |
|------|------|---------|---------|------|
| throttle_plan_tab | Checkout | plan_id,plan_status | LocalCache主用 | 限流计划表 |
| throttle_effective_time_tab | Checkout | plan_id,effective_time | LocalCache主用 | 生效时间表 |
| throttle_order_account_tab | Checkout | plan_id,order_account | LocalCache主用 | 订单账户关联表 |
| throttle_shop_tab | Checkout | plan_id,shop_id | LocalCache主用 | 店铺关联表 |
| throttle_rule_tab | Checkout | plan_id,origin/dest | LocalCache主用 | 规则表 |
| throttle_threshold_tab | Checkout | plan_id,threshold | LocalCache主用 | 阈值表 |
| site_solution_tab | Network | version_id,site_id | 缓存主用 | 站点解决方案表 |
| pickup_point_tab | Pickup | shop_address_checksum | **无缓存** | 每次必查 |
| pup_white_list_record_tab | Pickup | pickup_point_id | Redis主用 | 20-40%穿透 |
| division_mapping_tab | SmartSorting | original_division_hash | Redis主用 | 20-40%穿透 |
| zone_collection_tab | SmartSorting | business_key,status | LocalCache主用 | 10-20%穿透 |
| zone_version_tab | SmartSorting | zone_collection_id | LocalCache主用 | 10-20%穿透 |
| admin_zone_index_tab | SmartSorting | 地理坐标 | DB主用 | MatchZone主用 |
| zone_cell_tab | SmartSorting | zone_collection_id | **无缓存** | 性能瓶颈点 |
| hub_whitelist_tab | SmartSorting | business_type,station_id | LocalCache主用 | 10-20%穿透 |
| conf_whitelist_division_tab | SmartSorting | 全部启用记录 | Redis主用 | 20-40%穿透 |
| geometry_hash_manager_tab | Address(PMS) | 几何哈希 | 无缓存 | 可选调用 |

---

## 13. 监控面板指标详解

本章节详细讲解MySQL和Redis监控面板中各项指标的含义，帮助在压测过程中正确理解和分析数据。

### 13.1 MySQL监控指标详解

#### 13.1.1 Resource Overview（资源概览）

| 指标 | 含义 | 压测关注点 | 告警阈值 |
|------|------|-----------|---------|
| **CPU used%** | CPU使用率 | 核心指标，压测时观察变化 | >80%需扩容 |
| **Memory used%** | 内存使用率 | 观察是否持续上升 | >85%危险 |
| **5m load** | 5分钟系统负载 | 对比CPU核数 | >核数说明过载 |
| **CPU Cores** | CPU核心数 | 参考基准 | - |
| **Disk read/write** | 磁盘读写速度 | 观察IO是否瓶颈 | - |
| **Current QPS** | 当前每秒查询数 | **核心指标** | - |
| **InnoDB Buffer Pool Size** | InnoDB缓冲池大小 | 热数据能否放入内存 | - |

#### 13.1.2 Connections（连接相关）

| 指标 | 含义 | 压测关注点 | 正常范围 |
|------|------|-----------|---------|
| **MySQL Connections** | 最大连接数 | 观察是否接近上限 | <上限80% |
| **MySQL Client Thread Activity** | 活跃线程数 | 压测时会显著增加 | - |
| **QPS - Read & Write** | 读写QPS分布 | 了解读写比例 | - |
| **Errors/s** | 每秒错误数 | **必须关注**，不应增加 | 0 |
| **MySQL UP** | 数据库是否在线 | 确保不宕机 | UP |
| **Read Only** | 只读模式 | 主库OFF，从库ON | - |

#### 13.1.3 Slow Queries & Locks

| 指标 | 含义 | 压测关注点 | 告警阈值 |
|------|------|-----------|---------|
| **MySQL Slow Queries** | 慢查询数 | **必须为0或极低** | >0告警 |
| **MySQL Table Locks** | 表锁等待 | 锁竞争指标 | 越低越好 |
| **MySQL Sorts** | 排序操作次数 | 大量排序影响性能 | - |
| **MySQL Aborted Connections** | 中断连接数 | 连接异常断开 | <0.5/s |

#### 13.1.4 Memory（内存相关）

| 指标 | 含义 | 压测关注点 |
|------|------|-----------|
| **InnoDB Buffer Pool Data** | 缓冲池数据大小 | 热数据缓存 |
| **Adaptive Hash Index Size** | 自适应哈希索引 | 加速等值查询 |
| **Com_select** | SELECT命令数 | 读查询量 |
| **Com_update** | UPDATE命令数 | 写操作量 |
| **Com_begin/commit** | 事务数 | 事务频率 |

#### 13.1.5 Handlers（处理器操作）

| 指标 | 含义 | 压测关注点 |
|------|------|-----------|
| **read_rnd_next** | 随机读取下一行 | 过高说明有全表扫描 |
| **write** | 写入行数 | 写入量 |
| **read_key** | 索引读取 | 索引使用情况 |
| **read_next** | 范围扫描下一行 | 范围查询 |
| **commit** | 提交事务数 | 事务频率 |

#### 13.1.6 Replication（主从复制）

| 指标 | 含义 | 压测关注点 | 告警阈值 |
|------|------|-----------|---------|
| **Seconds Behind Master** | 主从延迟 | **必须关注** | >10s告警 |
| **Table Response Histogram** | 响应时间分布 | 大部分应在10ms内 | - |
| **Replication Status** | 复制状态 | io_running/sql_running: YES | - |

#### 13.1.7 MySQL指标与统计表对应

| 统计表列 | 监控面板指标 | 获取位置 |
|---------|-------------|---------|
| **QPS** | Current QPS | Resource Overview |
| **Failure** | Errors/s | Connections面板 |
| **Failure %** | Errors/s ÷ QPS × 100% | 计算得出 |
| **Avg (ms)** | Table Response Histogram | Replication面板 |
| **P95/P99 (ms)** | 需要APM数据 | - |
| **CPU使用率** | CPU used% | Resource Overview |
| **内存使用率** | Memory used% | Resource Overview |

### 13.2 Redis监控指标详解

#### 13.2.1 Overall（整体概览）

| 指标 | 含义 | 压测关注点 | 告警阈值 |
|------|------|-----------|---------|
| **Online Proxies** | Proxy在线率 | 必须保持100% | <100%告警 |
| **Online Instances** | Redis实例在线率 | 必须保持100% | <100%告警 |
| **Total Redis Memory Online** | 集群总内存 | 固定配置 | - |
| **Current Max Proxy CPU** | Proxy最大CPU | 观察是否成为瓶颈 | - |
| **Total Memory Usage** | 内存使用率 | **关键指标** | >85%告警 |
| **maxmemory_policy** | 内存淘汰策略 | 了解淘汰机制 | - |

#### 13.2.2 Proxy Stats（代理层统计）

| 指标 | 含义 | 压测关注点 |
|------|------|-----------|
| **CPU Usage by proxy** | Proxy CPU使用率 | 压测时观察上升 |
| **QPS by proxy** | 每个Proxy的QPS | **核心指标** |
| **Latency by proxy (AVG)** | 平均延迟 | 对应Avg(ms) |
| **Client Connections by proxy** | 客户端连接数 | 连接池使用情况 |
| **Memory Usage by proxy** | Proxy内存使用 | Proxy自身内存 |

#### 13.2.3 Cluster & Command Stats

| 指标 | 含义 | 压测关注点 | 告警阈值 |
|------|------|-----------|---------|
| **total QPS of cluster** | 集群总QPS | **核心指标** | - |
| **New conns Per Min** | 每分钟新连接数 | 连接创建频率 | - |
| **Conns Rejected Per Min** | 每分钟拒绝连接数 | **必须为0** | >0告警 |
| **total QPS by cmd** | 各命令QPS | 了解命令分布 | - |

#### 13.2.4 Instance Stats（实例统计）

| 指标 | 含义 | 压测关注点 | 告警阈值 |
|------|------|-----------|---------|
| **Key Count** | Key数量 | 数据规模 | - |
| **Master Slave offset** | 主从同步偏移量 | **必须为0或极小** | >1MB告警 |
| **Cluster hit / miss qps** | 缓存命中/未命中QPS | **命中率核心指标** | - |
| **expire keys rate** | Key过期速率 | 过期情况 | - |
| **slowlog length** | 慢日志长度 | 慢命令数量 | 越低越好 |
| **Redis Blocked Clients** | 阻塞客户端数 | **必须为0** | >0告警 |
| **evit key rate** | Key淘汰速率 | 内存不足时会淘汰 | >0需关注 |
| **Memory Fragmentation Ratio** | 内存碎片率 | <1.5正常 | >2.0告警 |

#### 13.2.5 Health Check（健康检查）

| 指标 | 含义 | 压测关注点 | 告警阈值 |
|------|------|-----------|---------|
| **Current Status** | 当前健康状态 | **必须100%** | <100%告警 |
| **7Day Availability** | 7天可用性 | SLA指标 | <99.9%告警 |
| **P99 Latency (Last 5 min)** | 最近5分钟P99延迟 | **关键延迟指标** | >10ms告警 |
| **7D P95/P99 Latency** | 7天P95/P99延迟 | 长期基线 | - |
| **Requests Ratio (<5ms)** | 5ms内请求占比 | 响应时间分布 | <95%告警 |

#### 13.2.6 性能对比 & 错误

| 指标 | 含义 | 压测关注点 | 告警阈值 |
|------|------|-----------|---------|
| **error by cmd** | 各命令错误率 | **必须全部为0** | >0告警 |
| **Pipeline Number** | Pipeline数量 | 批量命令 | - |
| **QPS of master TOPK VS BOTTOMK** | 主节点QPS分布 | 负载均衡情况 | - |

#### 13.2.7 Redis指标与统计表对应

| 统计表列 | 监控面板指标 | 获取位置 |
|---------|-------------|---------|
| **QPS** | total QPS of cluster | Proxy Stats / Cluster Stats |
| **命中率** | hit / (hit + miss) × 100% | Instance Stats - Cluster hit/miss qps |
| **Failure** | error by cmd + Conns Rejected | 性能对比 / Cluster Stats |
| **Failure %** | Failure ÷ QPS × 100% | 计算得出 |
| **Avg (ms)** | Latency by proxy (AVG) | Proxy Stats (μs → ms转换) |
| **P95 (ms)** | 7D P95 Latency | Health Check (μs → ms转换) |
| **P99 (ms)** | P99 Latency (Last 5 min) | Health Check |

### 13.3 关键告警阈值汇总

#### 13.3.1 MySQL告警阈值

| 指标 | 正常范围 | 警告阈值 | 危险阈值 |
|------|---------|---------|---------|
| CPU使用率 | <70% | 70-85% | >85% |
| 内存使用率 | <70% | 70-85% | >85% |
| 慢查询 | 0 | >0 | 持续增加 |
| 错误率 | 0 | >0.1/s | >1/s |
| 主从延迟 | <1s | 1-5s | >10s |
| 连接数 | <80%上限 | 80-90% | >90% |

#### 13.3.2 Redis告警阈值

| 指标 | 正常范围 | 警告阈值 | 危险阈值 |
|------|---------|---------|---------|
| 可用性 | 100% | <99.9% | <99% |
| P99延迟 | <5ms | 5-10ms | >10ms |
| 内存使用率 | <80% | 80-85% | >85% |
| 错误率 | 0 | >0 | 持续增加 |
| Key淘汰率 | 0 | >0 | 持续增加 |
| 连接拒绝 | 0 | >0 | 持续增加 |
| 主从延迟 | 0 | >100KB | >1MB |
| 内存碎片率 | <1.5 | 1.5-2.0 | >2.0 |

---

## 14. 压测指标统计表模板

本章节提供压测过程中需要统计的各类指标表格模板。

### 14.1 服务接口指标

| 服务 | QPS | Failure | Failure % | Min (ms) | Max (ms) | Avg (ms) | P95 (ms) | P99 (ms) | CPU使用率 | 内存使用率 |
|------|-----|---------|-----------|----------|----------|----------|----------|----------|-----------|-----------|
| Checkout Service | | | | | | | | | | |
| Pickup Service | | | | | | | | | | |
| Smart Sorting - MatchZone | | | | | | | | | | |
| Smart Sorting - MatchPickupHubZoneV2 | | | | | | | | | | |
| Address Service (PMS) | | | | | | | | | | |

### 14.2 MySQL指标

| 表名 | QPS | Failure | Failure % | Min (ms) | Max (ms) | Avg (ms) | P95 (ms) | P99 (ms) |
|------|-----|---------|-----------|----------|----------|----------|----------|----------|
| pickup_point_tab (每次必查) | | | | | | | | |
| pup_white_list_record_tab | | | | | | | | |
| division_mapping_tab | | | | | | | | |
| zone_collection_tab | | | | | | | | |
| admin_zone_index_tab | | | | | | | | |
| zone_cell_tab (每次必查) | | | | | | | | |
| hub_whitelist_tab | | | | | | | | |
| conf_whitelist_division_tab | | | | | | | | |

### 14.3 Redis指标

| Key | QPS | 命中率 | Failure | Failure % | Min (ms) | Max (ms) | Avg (ms) | P95 (ms) | P99 (ms) |
|-----|-----|--------|---------|-----------|----------|----------|----------|----------|----------|
| pup_level_white_list_station_id_* | | | | | | | | | |
| division_mapping_* | | | | | | | | | |
| division_whitelist | | | | | | | | | |

### 14.4 LocalCache命中率

| 缓存类型 | QPS | 命中率 |
|---------|-----|--------|
| 限流配置缓存 | | |
| 区域集合缓存 | | |
| Station白名单缓存 | | |

### 14.5 服务间调用指标

| 调用链路 | QPS | Failure | Failure % | Min (ms) | Max (ms) | Avg (ms) | P95 (ms) | P99 (ms) |
|---------|-----|---------|-----------|----------|----------|----------|----------|----------|
| Network → Pickup | | | | | | | | |
| Network → Smart Sorting (MatchZone) | | | | | | | | |
| Network → Smart Sorting (MatchPickupHubZoneV2) | | | | | | | | |
| Smart Sorting → Address (PMS) | | | | | | | | |

### 14.6 端到端指标

| QPS | 端到端响应时间(P95) | 端到端响应时间(P99) | 端到端成功率 |
|-----|-------------------|-------------------|-------------|
| 1,000 | | | |
| 2,000 | | | |
| 3,000 | | | |
| 4,000 | | | |
| 5,000 | | | |
| 6,000 | | | |
| 6,850 | | | |

### 14.7 系统资源指标

| 服务/中间件 | QPS | CPU使用率 | 内存使用率 |
|------------|-----|-----------|-----------|
| Checkout Service | | | |
| Network Service | | | |
| Pickup Service | | | |
| Smart Sorting Service | | | |
| Address Service | | | |
| MySQL主库 | | | |
| MySQL从库 | | | |
| Redis | | | |
| Elasticsearch | | | |

---

> 📅 最后更新：2026-01-21
> 
> 📖 文档版本：v3.0（新增实战案例、监控面板指标详解、压测指标统计表模板章节）