# Mock çŸ¥è¯†æŒ‡å—

> æœ¬æ–‡æ¡£æ€»ç»“äº†å•å…ƒæµ‹è¯•ä¸­ Mock çš„æ ¸å¿ƒæ¦‚å¿µã€åŸç†å’Œæœ€ä½³å®è·µï¼Œé€‚åˆ QA æ–°äººå­¦ä¹ å’Œå¤ä¹ ã€‚

---

## ç›®å½•

1. [ä»€ä¹ˆæ˜¯ Mockï¼Ÿ](#1-ä»€ä¹ˆæ˜¯-mock)
2. [Mock çš„åŸç†](#2-mock-çš„åŸç†)
3. [ä¸ºä»€ä¹ˆéœ€è¦ Mockï¼Ÿ](#3-ä¸ºä»€ä¹ˆéœ€è¦-mock)
4. [Go è¯­è¨€ä¸­å¦‚ä½•å®ç° Mock](#4-go-è¯­è¨€ä¸­å¦‚ä½•å®ç°-mock)
5. [æˆåŠŸçš„å•å…ƒæµ‹è¯•æµç¨‹](#5-æˆåŠŸçš„å•å…ƒæµ‹è¯•æµç¨‹)
6. [ä¸ºä»€ä¹ˆå…¨å±€å˜é‡/å‡½æ•°éš¾ä»¥ Mockï¼Ÿ](#6-ä¸ºä»€ä¹ˆå…¨å±€å˜é‡å‡½æ•°éš¾ä»¥-mock)
7. [gomonkey çš„åŸç†å’Œä½¿ç”¨](#7-gomonkey-çš„åŸç†å’Œä½¿ç”¨)
8. [æœ‰æ•ˆæµ‹è¯• vs æ— æ•ˆæµ‹è¯•å¯¹æ¯”](#8-æœ‰æ•ˆæµ‹è¯•-vs-æ— æ•ˆæµ‹è¯•å¯¹æ¯”)
9. [Go è¯­è¨€åŸºç¡€ï¼šç»“æ„ä½“ä¸æ–¹æ³•](#9-go-è¯­è¨€åŸºç¡€ç»“æ„ä½“ä¸æ–¹æ³•)
10. [ä¾èµ–æ³¨å…¥è¯¦è§£](#10-ä¾èµ–æ³¨å…¥è¯¦è§£)
11. [æ€»ç»“](#11-æ€»ç»“)

---

## 1. ä»€ä¹ˆæ˜¯ Mockï¼Ÿ

### é€šä¿—ç†è§£

**Mock å°±æ˜¯"å‡è£…"ã€‚** åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª"å‡çš„"å¯¹è±¡æ¥ä»£æ›¿"çœŸçš„"å¯¹è±¡ã€‚

### ç”Ÿæ´»ä¸­çš„ä¾‹å­

```
åœºæ™¯ï¼šæµ‹è¯•æ¶ˆé˜²æ¼”ä¹ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çœŸå®æƒ…å†µï¼š                                                    â”‚
â”‚   - çœŸçš„ç€ç« ğŸ”¥                                              â”‚
â”‚   - çœŸçš„æ¶ˆé˜²å‘˜æ¥æ•‘ç«                                          â”‚
â”‚   - é—®é¢˜ï¼šå¤ªå±é™©äº†ï¼                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mock æ–¹å¼ï¼š                                                   â”‚
â”‚   - å‡è£…ç€ç«ï¼ˆçƒŸé›¾å¼¹ï¼‰â† è¿™å°±æ˜¯ Mock                           â”‚
â”‚   - çœŸçš„æ¶ˆé˜²å‘˜æ¥æ¼”ç»ƒ                                          â”‚
â”‚   - å¥½å¤„ï¼šå®‰å…¨åœ°æµ‹è¯•æ•´ä¸ªæµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç ä¸­çš„ Mock

```go
// çœŸå®åœºæ™¯ï¼šè°ƒç”¨çœŸæ­£çš„æ•°æ®åº“
func GetUser(db Database, id int) User {
    return db.Query("SELECT * FROM users WHERE id = ?", id)
}

// Mock æ–¹å¼ï¼šç”¨ä¸€ä¸ª"å‡çš„"æ•°æ®åº“
type MockDatabase struct {}

func (m *MockDatabase) Query(sql string, args ...interface{}) User {
    return User{ID: 1, Name: "æµ‹è¯•ç”¨æˆ·"}  // ç›´æ¥è¿”å›å‡æ•°æ®
}
```

---

## 2. Mock çš„åŸç†

### æ ¸å¿ƒåŸç†ï¼šæ›¿æ¢

Mock çš„æ ¸å¿ƒå°±æ˜¯**åœ¨æµ‹è¯•æ—¶ï¼Œç”¨æˆ‘ä»¬å¯æ§çš„å‡å¯¹è±¡æ›¿æ¢çœŸå®å¯¹è±¡**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ­£å¸¸è¿è¡Œæ—¶                              â”‚
â”‚                                                              â”‚
â”‚   ä¸šåŠ¡ä»£ç  â”€â”€è°ƒç”¨â”€â”€> çœŸå®ä¾èµ–ï¼ˆæ•°æ®åº“/ç½‘ç»œ/å¤–éƒ¨æœåŠ¡ï¼‰               â”‚
â”‚                         â”‚                                    â”‚
â”‚                         â†“                                    â”‚
â”‚                    çœŸå®ç»“æœï¼ˆå¯èƒ½æˆåŠŸ/å¤±è´¥/è¶…æ—¶ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æµ‹è¯•è¿è¡Œæ—¶                              â”‚
â”‚                                                              â”‚
â”‚   ä¸šåŠ¡ä»£ç  â”€â”€è°ƒç”¨â”€â”€> Mock å¯¹è±¡ï¼ˆæˆ‘ä»¬æ§åˆ¶çš„å‡å¯¹è±¡ï¼‰                 â”‚
â”‚                         â”‚                                    â”‚
â”‚                         â†“                                    â”‚
â”‚                    é¢„è®¾ç»“æœï¼ˆæˆ‘ä»¬å†³å®šè¿”å›ä»€ä¹ˆï¼‰                   â”‚  
â”‚                    - æƒ³æµ‹æˆåŠŸï¼Ÿè¿”å›æˆåŠŸ                         â”‚
â”‚                    - æƒ³æµ‹å¤±è´¥ï¼Ÿè¿”å›é”™è¯¯                         â”‚
â”‚                    - æƒ³æµ‹è¶…æ—¶ï¼Ÿè¿”å›è¶…æ—¶é”™è¯¯                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸€å¥è¯æ€»ç»“

**Mock å°±æ˜¯"æ›¿æ¢"ï¼Œèƒ½æ›¿æ¢çš„å‰ææ˜¯ä»£ç è®¾è®¡å…è®¸æ›¿æ¢ã€‚**

---

## 3. ä¸ºä»€ä¹ˆéœ€è¦ Mockï¼Ÿ

| é—®é¢˜ | ä¸ä½¿ç”¨ Mock | ä½¿ç”¨ Mock |
|------|------------|----------|
| æµ‹è¯•æ•°æ®åº“æ“ä½œ | éœ€è¦çœŸå®æ•°æ®åº“è¿æ¥ | ç”¨å‡å¯¹è±¡æ¨¡æ‹Ÿ |
| æµ‹è¯•ç½‘ç»œè¯·æ±‚ | éœ€è¦çœŸå®ç½‘ç»œç¯å¢ƒ | ç”¨å‡å¯¹è±¡è¿”å›é¢„è®¾å“åº” |
| æµ‹è¯•å¼‚å¸¸åœºæ™¯ | å¾ˆéš¾è§¦å‘çœŸå®é”™è¯¯ | ç›´æ¥è®© Mock è¿”å›é”™è¯¯ |
| æµ‹è¯•é€Ÿåº¦ | æ…¢ï¼ˆä¾èµ–å¤–éƒ¨æœåŠ¡ï¼‰ | å¿«ï¼ˆç›´æ¥è¿”å›ï¼‰ |
| æµ‹è¯•ç¨³å®šæ€§ | ä¸ç¨³å®šï¼ˆå¤–éƒ¨æœåŠ¡å¯èƒ½æŒ‚ï¼‰ | ç¨³å®šï¼ˆå®Œå…¨å¯æ§ï¼‰ |

---

## 4. Go è¯­è¨€ä¸­å¦‚ä½•å®ç° Mock

### æ–¹å¼ä¸€ï¼šæ¥å£æ›¿æ¢ï¼ˆæœ€å¸¸ç”¨ã€æœ€æ¨èï¼‰

```go
// 1. å®šä¹‰æ¥å£
type VideoService interface {
    GetImage(ctx context.Context, cameraID string) ([]byte, error)
}

// 2. çœŸå®å®ç°
type RealVideoService struct { /* è¿æ¥çœŸå®æœåŠ¡ */ }
func (r *RealVideoService) GetImage(ctx context.Context, cameraID string) ([]byte, error) {
    // çœŸæ­£å»è·å–å›¾ç‰‡
}

// 3. Mock å®ç°
type MockVideoService struct {
    mock.Mock
}
func (m *MockVideoService) GetImage(ctx context.Context, cameraID string) ([]byte, error) {
    args := m.Called(ctx, cameraID)
    return args.Get(0).([]byte), args.Error(1)
}

// 4. æµ‹è¯•æ—¶ä½¿ç”¨ Mock
func TestSomething(t *testing.T) {
    mockService := new(MockVideoService)
    mockService.On("GetImage", mock.Anything, "camera_001").
        Return(nil, errors.New("cache miss"))
    
    // æ³¨å…¥ Mock
    service := &DetectService{VideoService: mockService}
    
    // è°ƒç”¨ä¸šåŠ¡æ–¹æ³•
    err := service.DoSomething()
    
    // éªŒè¯
    assert.Error(t, err)
}
```

### å…³é”®ç‚¹

**ä¸šåŠ¡ä»£ç ä¾èµ–çš„æ˜¯æ¥å£ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°ã€‚æµ‹è¯•æ—¶æˆ‘ä»¬ä¼ å…¥ Mock å®ç°ã€‚**

---

## 5. æˆåŠŸçš„å•å…ƒæµ‹è¯•æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
æˆåŠŸçš„å•å…ƒæµ‹è¯•æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: å‡†å¤‡ Mock ä¾èµ–                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  mockVideoService := new(MockVideoService)                    â”‚  â”‚
â”‚  â”‚  mockVideoService.On("GetImage", ...).Return(nil, error)      â”‚  â”‚
â”‚  â”‚                                     â†‘                         â”‚  â”‚
â”‚  â”‚                              è®¾å®š"å½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œè¿”å›è¿™ä¸ªå€¼"     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â†“                                 â”‚
â”‚  Step 2: åˆ›å»ºè¢«æµ‹å¯¹è±¡ï¼Œæ³¨å…¥ Mock ä¾èµ–                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  service := &DetectService{                                   â”‚  â”‚
â”‚  â”‚      VideoService: mockVideoService,  â† æ³¨å…¥å‡å¯¹è±¡              â”‚  â”‚
â”‚  â”‚  }                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â†“                                 â”‚
â”‚  Step 3: è°ƒç”¨çœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  result, err := service.DetectDockOccupyRate(ctx, ...)        â”‚  â”‚
â”‚  â”‚                  â†‘                                            â”‚  â”‚
â”‚  â”‚           è¿™æ˜¯æºä»£ç ä¸­çš„æ–¹æ³•ï¼Œä¼šè¢«çœŸæ­£æ‰§è¡Œï¼                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â†“                                 â”‚
â”‚  Step 4: éªŒè¯ç»“æœ                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  assert.Error(t, err)                     // éªŒè¯è¿”å›äº†é”™è¯¯     â”‚  â”‚
â”‚  â”‚  assert.Equal(t, expected, result)        // éªŒè¯è¿”å›å€¼æ­£ç¡®     â”‚  â”‚
â”‚  â”‚  mockVideoService.AssertExpectations(t)   // éªŒè¯Mockè¢«è°ƒç”¨äº†   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç ç¤ºä¾‹

```go
// âœ… æˆåŠŸçš„å•æµ‹
func TestDetectDockOccupyRate_CacheError(t *testing.T) {
    // Step 1: å‡†å¤‡ Mock
    mockVideoService := new(MockVideoService)
    mockVideoService.On("GetDockDetectImageFromCache", mock.Anything, "camera_001").
        Return(nil, uint64(0), uint64(0), uint64(0), errors.New("cache miss"))
    
    // Step 2: åˆ›å»ºè¢«æµ‹å¯¹è±¡ï¼Œæ³¨å…¥ Mock
    service := &DetectService{
        VideoService: mockVideoService,
    }
    
    // Step 3: è°ƒç”¨çœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•
    err := service.DetectDockOccupyRate(ctx, stationIDs, gsheetID)
    
    // Step 4: éªŒè¯ç»“æœ
    assert.Error(t, err)
    mockVideoService.AssertExpectations(t)
}
```

---

## 6. ä¸ºä»€ä¹ˆå…¨å±€å˜é‡/å‡½æ•°éš¾ä»¥ Mockï¼Ÿ

### é—®é¢˜ä»£ç ç¤ºä¾‹

```go
// å…¨å±€å˜é‡
var DockModelPool = NewModelPool()

// å…¨å±€å‡½æ•°
func ModelDetect(img Image) Result {
    return DockModelPool.Detect(img)
}

// ä¸šåŠ¡ä»£ç ç›´æ¥ä½¿ç”¨
func DetectDockOccupyRate() {
    poolSize := DockModelPool.Size()   // ç›´æ¥ç”¨å…¨å±€å˜é‡
    result := ModelDetect(img)          // ç›´æ¥è°ƒç”¨å…¨å±€å‡½æ•°
}
```

### ä¸ºä»€ä¹ˆéš¾ä»¥ Mockï¼Ÿ

| ç±»å‹ | é—®é¢˜ | åŸå›  |
|------|------|------|
| **æ¥å£** | âœ… å¯ä»¥ Mock | å¯ä»¥é€šè¿‡èµ‹å€¼æ›¿æ¢æˆ Mock å¯¹è±¡ |
| **å…¨å±€å˜é‡** | âŒ éš¾ä»¥ Mock | ç¨‹åºå¯åŠ¨æ—¶å°±åˆå§‹åŒ–ï¼Œæµ‹è¯•æ—¶éš¾ä»¥æ›¿æ¢ |
| **å…¨å±€å‡½æ•°** | âŒ éš¾ä»¥ Mock | å‡½æ•°ä¸æ˜¯å˜é‡ï¼ŒGo æ ‡å‡†æ–¹å¼æ— æ³•æ›¿æ¢ |

```
æ¥å£æ–¹å¼ï¼ˆå¯ä»¥ Mockï¼‰ï¼š
   DetectService.VideoService = MockVideoService{}
   â†‘
   é€šè¿‡èµ‹å€¼ï¼Œæˆ‘ä»¬å¯ä»¥"æ›¿æ¢"æˆ Mock å¯¹è±¡

å…¨å±€å˜é‡æ–¹å¼ï¼ˆéš¾ä»¥ Mockï¼‰ï¼š
   var DockModelPool = NewModelPool()  â† ç¨‹åºå¯åŠ¨æ—¶å°±åˆå§‹åŒ–äº†
   é—®é¢˜1ï¼šå…¨å±€å˜é‡åœ¨åŒ…çº§åˆ«å®šä¹‰ï¼Œæµ‹è¯•æ—¶éš¾ä»¥æ›¿æ¢
   é—®é¢˜2ï¼šå¤šä¸ªæµ‹è¯•å¹¶è¡Œè¿è¡Œæ—¶ï¼Œä¿®æ”¹å…¨å±€å˜é‡ä¼šäº’ç›¸å½±å“

å…¨å±€å‡½æ•°æ–¹å¼ï¼ˆéš¾ä»¥ Mockï¼‰ï¼š
   func ModelDetect(img Image) Result { ... }
   é—®é¢˜ï¼šå‡½æ•°æ˜¯å›ºå®šçš„ï¼ŒGo æ ‡å‡†æ–¹å¼æ— æ³•"æ›¿æ¢"ä¸€ä¸ªå‡½æ•°
```

---

## 7. gomonkey çš„åŸç†å’Œä½¿ç”¨

### gomonkey çš„åŸç†ï¼šè¿è¡Œæ—¶ä¿®æ”¹å‡½æ•°æŒ‡ä»¤

```
æ™®é€š Mockï¼ˆæ¥å£æ›¿æ¢ï¼‰ï¼š
   ç¼–è¯‘æ—¶å†³å®šè°ƒç”¨å“ªä¸ªå®ç°
   é€šè¿‡ä¼ å…¥ä¸åŒçš„å¯¹è±¡æ¥åˆ‡æ¢

gomonkeyï¼ˆè¿è¡Œæ—¶ Patchï¼‰ï¼š
   åœ¨å†…å­˜ä¸­ç›´æ¥ä¿®æ”¹å‡½æ•°çš„æœºå™¨ç ï¼

   åŸå§‹å‡½æ•°ï¼š
     func ModelDetect() Result {
         // åŸå§‹é€»è¾‘
     }
                   â†“ gomonkey ä¿®æ”¹
   è¢« Patch åï¼š
     func ModelDetect() Result {
         jump åˆ°æˆ‘ä»¬çš„ Mock å‡½æ•°  â† ç›´æ¥è·³è½¬åˆ°å‡å‡½æ•°
     }
```

### gomonkey ç¤ºä¾‹

```go
import "github.com/agiledragon/gomonkey/v2"

func TestWithGomonkey(t *testing.T) {
    // Patch å…¨å±€å‡½æ•° ModelDetect
    patches := gomonkey.ApplyFunc(ModelDetect, func(img Image) Result {
        return Result{Occupied: true}  // è¿”å›æˆ‘ä»¬æƒ³è¦çš„å‡ç»“æœ
    })
    defer patches.Reset()  // æµ‹è¯•ç»“æŸåæ¢å¤åŸå‡½æ•°
    
    // ç°åœ¨è°ƒç”¨ä¸šåŠ¡ä»£ç æ—¶ï¼ŒModelDetect ä¼šè¿”å›æˆ‘ä»¬çš„å‡ç»“æœ
    result := DetectDockOccupyRate()
}
```

### gomonkey çš„ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| å¯ä»¥ Mock å…¨å±€å‡½æ•° | åªèƒ½åœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨ |
| å¯ä»¥ Mock å…¨å±€å˜é‡çš„æ–¹æ³• | ä¾èµ– CPU æ¶æ„ï¼ˆx86/ARMï¼‰ |
| ä¸éœ€è¦ä¿®æ”¹æºä»£ç  | å¯èƒ½è¢« Go ç¼–è¯‘å™¨å†…è”ä¼˜åŒ–ç ´å |
| | éœ€è¦ç¦ç”¨å†…è”ï¼š`go test -gcflags="-N -l"` |

---

## 8. æœ‰æ•ˆæµ‹è¯• vs æ— æ•ˆæµ‹è¯•å¯¹æ¯”

### âŒ æ— æ•ˆçš„æµ‹è¯•ï¼ˆè‡ªå·±å†™é€»è¾‘ï¼Œæ²¡æœ‰è°ƒç”¨æºä»£ç ï¼‰

```go
func TestProcessDockItem_CacheError(t *testing.T) {
    // âŒ è‡ªå·±åˆ›å»ºé”™è¯¯
    cacheErr := errors.New("cache miss")
    
    // âŒ è‡ªå·±å†™å¤„ç†é€»è¾‘
    sendUnknownResult := func() {
        resultChan <- &dockDefine.DetectResult{...}
    }
    
    // âŒ è‡ªå·±æ‰§è¡Œåˆ¤æ–­
    if cacheErr != nil {
        sendUnknownResult()
    }
    
    // é—®é¢˜ï¼šå®Œå…¨æ˜¯è‡ªå·±å†™çš„ä»£ç ï¼Œä»æœªè°ƒç”¨ impl.go ä¸­çš„ä»»ä½•æ–¹æ³•ï¼
    // ä»£ç è¦†ç›–ç‡ï¼š0%
}
```

### âœ… æœ‰æ•ˆçš„æµ‹è¯•ï¼ˆè°ƒç”¨çœŸå®æ–¹æ³•ï¼ŒMock ä¾èµ–ï¼‰

```go
func TestDetectDockOccupyRate_CacheError(t *testing.T) {
    // âœ… åˆ›å»º Mock
    mockVideoService := new(MockVideoService)
    mockVideoService.On("GetDockDetectImageFromCache", mock.Anything, mock.Anything).
        Return(nil, uint64(0), uint64(0), uint64(0), errors.New("cache miss"))
    
    // âœ… æ³¨å…¥ Mock
    service := &DetectService{VideoService: mockVideoService}
    
    // âœ… è°ƒç”¨çœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•
    err := service.DetectDockOccupyRate(ctx, stationIDs, gsheetID)
    
    // âœ… éªŒè¯ç»“æœ
    assert.Error(t, err)
    
    // çœŸæ­£æ‰§è¡Œäº† impl.go ä¸­çš„ä»£ç ï¼Œè¦†ç›–äº†å¼‚å¸¸å¤„ç†åˆ†æ”¯ï¼
}
```

### å¯¹æ¯”è¡¨

| å¯¹æ¯”é¡¹ | æ— æ•ˆæµ‹è¯• | æœ‰æ•ˆæµ‹è¯• |
|--------|---------|---------|
| è°ƒç”¨çœŸå®å‡½æ•°ï¼Ÿ | âŒ æ²¡æœ‰ | âœ… è°ƒç”¨äº† |
| ä½¿ç”¨ Mockï¼Ÿ | âŒ æ²¡æœ‰ | âœ… Mock äº†ä¾èµ– |
| è¦†ç›–æºä»£ç ï¼Ÿ | âŒ 0% | âœ… è¦†ç›–å¼‚å¸¸åˆ†æ”¯ |
| æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ | è‡ªå·±å†™é€»è¾‘æ¼”ç¤º | çœŸæ­£çš„å•å…ƒæµ‹è¯• |

---

## 9. Go è¯­è¨€åŸºç¡€ï¼šç»“æ„ä½“ä¸æ–¹æ³•

### ç»“æ„ä½“å®šä¹‰

```go
type DetectService struct {
    VideoService            service.VideoService       // å­—æ®µ1ï¼šè§†é¢‘æœåŠ¡
    cameraAPI               camera.CameraService       // å­—æ®µ2ï¼šæ‘„åƒå¤´æœåŠ¡
    googleSheet             googlesheet.SheetService   // å­—æ®µ3ï¼šè¡¨æ ¼æœåŠ¡
}
```

### ä¸ºç»“æ„ä½“å®šä¹‰æ–¹æ³•

```go
func (d *DetectService) DetectDockOccupyRate(ctx context.Context, ...) error {
     â†‘
     è¿™éƒ¨åˆ†å«åš"æ¥æ”¶è€…(receiver)"
     è¡¨ç¤ºè¿™ä¸ªæ–¹æ³•å±äº DetectService
}
```

### è°ƒç”¨æ–¹æ³•

```go
// åˆ›å»ºå®ä¾‹
service := &DetectService{
    VideoService: mockVideoService,
}

// é€šè¿‡å®ä¾‹è°ƒç”¨æ–¹æ³•
err := service.DetectDockOccupyRate(ctx, stationIDs, gsheetID)
        â†‘        â†‘
        â”‚        â””â”€â”€ æ–¹æ³•å
        â””â”€â”€ DetectService çš„å®ä¾‹
```

### ç±»æ¯”å…¶ä»–è¯­è¨€

```java
// Java
class DetectService {
    public void detectDockOccupyRate() { ... }
}
service.detectDockOccupyRate();
```

```python
# Python
class DetectService:
    def detect_dock_occupy_rate(self): ...
service.detect_dock_occupy_rate()
```

```go
// Go
type DetectService struct { ... }
func (d *DetectService) DetectDockOccupyRate() { ... }
service.DetectDockOccupyRate()
```

---

## 10. ä¾èµ–æ³¨å…¥è¯¦è§£

### ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ

**ä¾èµ–ä»å¤–éƒ¨ä¼ å…¥ï¼Œè€Œä¸æ˜¯å†…éƒ¨åˆ›å»ºã€‚**

```go
// âŒ å†…éƒ¨åˆ›å»ºä¾èµ–ï¼ˆéš¾ä»¥æµ‹è¯•ï¼‰
func NewDetectService() *DetectService {
    return &DetectService{
        VideoService: NewRealVideoService(),  // å†…éƒ¨å†™æ­»äº†
    }
}

// âœ… å¤–éƒ¨æ³¨å…¥ä¾èµ–ï¼ˆæ˜“äºæµ‹è¯•ï¼‰
func NewDetectService(videoService VideoService) *DetectService {
    return &DetectService{
        VideoService: videoService,  // ä»å¤–éƒ¨ä¼ å…¥
    }
}
```

### ä¾èµ–æ³¨å…¥çš„å¥½å¤„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­£å¸¸è¿è¡Œæ—¶ï¼š                                                                 â”‚
â”‚                                                                             â”‚
â”‚  DetectService {                                                            â”‚
â”‚      VideoService: RealVideoService{}    â† çœŸå®å®ç°ï¼Œè¿æ¥ Redis               â”‚
â”‚  }                                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æµ‹è¯•è¿è¡Œæ—¶ï¼š                                                                 â”‚
â”‚                                                                             â”‚
â”‚  DetectService {                                                            â”‚
â”‚      VideoService: MockVideoService{}    â† Mock å®ç°ï¼Œè¿”å›å‡æ•°æ®               â”‚
â”‚  }                                                                          â”‚
â”‚                                                                             â”‚
â”‚  âœ… åŒä¸€ä¸ª DetectServiceï¼Œå¯ä»¥æ³¨å…¥ä¸åŒçš„å®ç°ï¼                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç±»æ¯”ï¼šåƒæ’åº§å’Œç”µå™¨

```
DetectServiceï¼ˆè®¾å¤‡ï¼‰çš„å­—æ®µå°±åƒ"æ’åº§"ï¼š

   â—‹ VideoService      â† æ’åº§1ï¼šéœ€è¦æ’å…¥ä¸€ä¸ª"è§†é¢‘æœåŠ¡"
   â—‹ cameraAPI         â† æ’åº§2ï¼šéœ€è¦æ’å…¥ä¸€ä¸ª"æ‘„åƒå¤´æœåŠ¡"
   â—‹ googleSheet       â† æ’åº§3ï¼šéœ€è¦æ’å…¥ä¸€ä¸ª"è¡¨æ ¼æœåŠ¡"

æ­£å¸¸è¿è¡Œï¼šæ’å…¥çœŸæ­£çš„ç”µå™¨ï¼ˆçœŸå®æœåŠ¡ï¼‰
æµ‹è¯•æ—¶ï¼š  æ’å…¥å‡ç”µå™¨ï¼ˆMock æœåŠ¡ï¼‰

è®¾å¤‡ä¸å…³å¿ƒæ’çš„æ˜¯ä»€ä¹ˆï¼Œåªè¦ç¬¦åˆ"æ’åº§è§„æ ¼"ï¼ˆæ¥å£å®šä¹‰ï¼‰å°±è¡Œ
```

---

## 11. æ€»ç»“

### Mock çš„æ ¸å¿ƒæµç¨‹

```
1. åˆ›å»ºå‡å¯¹è±¡ â†’ mockVideoService
2. å®šä¹‰å‡è¡Œä¸º â†’ .On(...).Return(...)
3. æ³¨å…¥å‡å¯¹è±¡ â†’ service := &DetectService{VideoService: mock}
4. è°ƒç”¨çœŸæ–¹æ³• â†’ service.DetectDockOccupyRate(...)
5. çœŸæ–¹æ³•å†…éƒ¨è°ƒç”¨ä¾èµ–æ—¶ â†’ å®é™…æ‰§è¡Œçš„æ˜¯å‡å¯¹è±¡çš„å‡è¡Œä¸º
6. å¼‚å¸¸åœºæ™¯è¢«è§¦å‘ â†’ è¦†ç›–åˆ°å¼‚å¸¸å¤„ç†ä»£ç 
```

### ä¸åŒ Mock æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | å®ç°æ–¹æ³• | æ˜¯å¦éœ€è¦æ”¹æºç  | æ¨èç¨‹åº¦ |
|------|---------|---------------|---------|
| **æ¥å£æ›¿æ¢** | å®šä¹‰æ¥å£ï¼Œæ³¨å…¥ä¸åŒå®ç° | éœ€è¦ï¼ˆè®¾è®¡æ—¶è€ƒè™‘ï¼‰ | â­â­â­â­â­ æœ€æ¨è |
| **å‡½æ•°å˜é‡** | å…¨å±€å‡½æ•°æ”¹ä¸ºå‡½æ•°ç±»å‹å˜é‡ | éœ€è¦ï¼ˆå°æ”¹åŠ¨ï¼‰ | â­â­â­â­ æ¨è |
| **å‡½æ•°å‚æ•°** | å°†å‡½æ•°ä½œä¸ºå‚æ•°ä¼ å…¥ | éœ€è¦ï¼ˆæ”¹å‡½æ•°ç­¾åï¼‰ | â­â­â­â­ æ¨è |
| **gomonkey** | è¿è¡Œæ—¶ä¿®æ”¹å‡½æ•°æœºå™¨ç  | ä¸éœ€è¦ | â­â­ æœ€åæ‰‹æ®µ |

### æœ€ä½³å®è·µ

1. **è®¾è®¡ä»£ç æ—¶è€ƒè™‘å¯æµ‹è¯•æ€§** - ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œé¿å…å…¨å±€å˜é‡/å‡½æ•°
2. **çº¯å‡½æ•°æœ€å¥½æµ‹** - å°½é‡æŠŠæ ¸å¿ƒé€»è¾‘æå–ä¸ºçº¯å‡½æ•°ï¼ˆè¾“å…¥å†³å®šè¾“å‡ºï¼Œæ— å‰¯ä½œç”¨ï¼‰
3. **gomonkey æ˜¯æœ€åæ‰‹æ®µ** - å½“æ— æ³•ä¿®æ”¹æºç æ—¶æ‰ä½¿ç”¨

### ä¸€å¥è¯æ€»ç»“

**Mock å°±æ˜¯ç”¨å¯æ§çš„å‡å¯¹è±¡æ›¿æ¢ä¸å¯æ§çš„çœŸä¾èµ–ï¼Œä»è€Œç²¾ç¡®æ§åˆ¶æµ‹è¯•åœºæ™¯ã€‚**

---

## é™„å½•ï¼šå¸¸ç”¨ Mock æ¡†æ¶

| æ¡†æ¶ | ç”¨é€” | å®‰è£… |
|------|------|------|
| [testify/mock](https://github.com/stretchr/testify) | æ¥å£ Mock | `go get github.com/stretchr/testify` |
| [gomock](https://github.com/golang/mock) | æ¥å£ Mockï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ | `go get github.com/golang/mock/mockgen` |
| [gomonkey](https://github.com/agiledragon/gomonkey) | å…¨å±€å‡½æ•°/å˜é‡ Patch | `go get github.com/agiledragon/gomonkey/v2` |

---

*æ–‡æ¡£åˆ›å»ºæ—¥æœŸï¼š2025-12-25*
*åŸºäºå®é™…é¡¹ç›®æ¡ˆä¾‹æ€»ç»“*

