# Code Guardian MCP å·¥å…·ä½¿ç”¨æŒ‡å—

## ç›®å½•

1. [å·¥å…·æ¦‚è¿°](#1-å·¥å…·æ¦‚è¿°)
2. [åŠŸèƒ½ç‰¹æ€§](#2-åŠŸèƒ½ç‰¹æ€§)
3. [ç¯å¢ƒè¦æ±‚](#3-ç¯å¢ƒè¦æ±‚)
4. [å·¥å…·ä½¿ç”¨æ–¹æ³•](#4-å·¥å…·ä½¿ç”¨æ–¹æ³•)
5. [ä½¿ç”¨ç¤ºä¾‹](#5-ä½¿ç”¨ç¤ºä¾‹)
6. [æœ€ä½³å®è·µ](#6-æœ€ä½³å®è·µ)
7. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#7-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
8. [ä¼˜åŒ–å»ºè®®](#8-ä¼˜åŒ–å»ºè®®)
9. [é™„å½•](#9-é™„å½•)

---

## 1. å·¥å…·æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯ Code Guardian

**Code Guardian** æ˜¯ä¸€ä¸ªåŸºäº MCP (Model Context Protocol) çš„æ™ºèƒ½ä»£ç è¦†ç›–ç‡æå‡å·¥å…·ã€‚å®ƒé€šè¿‡ä¸ AI åä½œï¼Œè‡ªåŠ¨åŒ–å®Œæˆä»¥ä¸‹æ ¸å¿ƒä»»åŠ¡ï¼š

- ğŸ” **è¦†ç›–ç‡åˆ†æ**: ä» DMS å¹³å°è·å–ä»£ç è¦†ç›–ç‡æ•°æ®ï¼Œç²¾å‡†è¯†åˆ«æœªè¦†ç›–çš„ä»£ç å—
- ğŸ§ª **æµ‹è¯•ç”Ÿæˆ**: åŸºäºæœªè¦†ç›–ä»£ç å—æ™ºèƒ½ç”Ÿæˆå•å…ƒæµ‹è¯•
- âœ… **æµ‹è¯•éªŒè¯**: æœ¬åœ°æ‰§è¡Œæµ‹è¯•ï¼Œç¡®ä¿æµ‹è¯•ç”¨ä¾‹æ­£ç¡®é€šè¿‡
- ğŸ“¤ **ä»£ç æ¨é€**: è‡ªåŠ¨æäº¤å’Œæ¨é€æµ‹è¯•ä»£ç åˆ°è¿œç¨‹ä»“åº“
- ğŸš€ **DMS è§¦å‘**: è§¦å‘ DMS ä»»åŠ¡æ‰§è¡Œè¦†ç›–ç‡éªŒè¯

### 1.2 æ ¸å¿ƒä»·å€¼

| ä»·å€¼ç»´åº¦ | æè¿° |
|---------|------|
| **æ•ˆç‡æå‡** | è‡ªåŠ¨åŒ–è¯†åˆ«æœªè¦†ç›–ä»£ç ï¼Œå‡å°‘äººå·¥åˆ†ææ—¶é—´ |
| **è´¨é‡ä¿éšœ** | ç³»ç»Ÿæ€§è¡¥å……æµ‹è¯•ç”¨ä¾‹ï¼Œæå‡ä»£ç è¦†ç›–ç‡ |
| **æ ‡å‡†åŒ–** | éµå¾ªç»Ÿä¸€çš„æµ‹è¯•è§„èŒƒï¼Œä¿è¯ä»£ç è´¨é‡ä¸€è‡´æ€§ |
| **å¯è¿½æº¯** | ç”Ÿæˆè¯¦ç»†çš„æ‰§è¡ŒæŠ¥å‘Šï¼Œä¾¿äºè¿½è¸ªå’Œå®¡è®¡ |

### 1.3 å·¥ä½œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Code Guardian æµç¨‹å›¾                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ å‚æ•°éªŒè¯  â”‚â”€â”€â”€â–¶â”‚ è·å–è¦†ç›–ç‡æ•°æ®  â”‚â”€â”€â”€â–¶â”‚ è§£ææœªè¦†ç›–å—   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                              â”‚                      â”‚
â”‚                                              â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ æ¨é€ä»£ç   â”‚â—€â”€â”€â”€â”‚  æ‰§è¡Œæµ‹è¯•      â”‚â—€â”€â”€â”€â”‚  ç”Ÿæˆæµ‹è¯•æ–‡ä»¶  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚        â”‚                                                            â”‚
â”‚        â–¼                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ è§¦å‘ DMS  â”‚â”€â”€â”€â–¶â”‚  ç”ŸæˆæŠ¥å‘Š     â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. åŠŸèƒ½ç‰¹æ€§

### 2.1 æ ¸å¿ƒå·¥å…·åˆ—è¡¨

| å·¥å…·åç§° | åŠŸèƒ½æè¿° | å¿…éœ€å‚æ•° |
|---------|---------|---------|
| `validate_and_confirm` | éªŒè¯å’Œç¡®è®¤æ‰€æœ‰å¿…å¡«å‚æ•° | git_repo, git_branch, target_branch, env, ssc_org_id |
| `get_and_parse_uncovered_blocks` | è·å–è¦†ç›–ç‡æ•°æ®å¹¶è§£ææœªè¦†ç›–ä»£ç å— | git_repo, git_branch, env, ssc_org_id |
| `generate_test_file` | ç”Ÿæˆæµ‹è¯•æ–‡ä»¶æ¡†æ¶ | uncovered_blocks |
| `write_test_code` | å†™å…¥æµ‹è¯•ä»£ç  | test_file_path, test_code |
| `execute_test` | æ‰§è¡Œæµ‹è¯• | test_file_path |
| `fix_test_failure` | ä¿®å¤æµ‹è¯•å¤±è´¥ | test_file_path, fixed_test_code |
| `push_to_repo` | æ¨é€ä»£ç åˆ°ä»“åº“ | (å¯é€‰å‚æ•°) |
| `trigger_dms_task` | è§¦å‘ DMS ä»»åŠ¡ | git_repo, branch_name, repo_id, jira_key |
| `generate_summary` | ç”Ÿæˆæ‰§è¡Œæ€»ç»“ | execution_data |
| `report_usage_to_aura` | ä¸ŠæŠ¥ä½¿ç”¨æƒ…å†µåˆ° Aura | execution_data |

### 2.2 æ”¯æŒçš„ç¼–ç¨‹è¯­è¨€

- âœ… Go (ä¸»è¦æ”¯æŒ)

### 2.3 æ”¯æŒçš„æµ‹è¯•æ¡†æ¶

- Go testing æ ‡å‡†åº“
- testify/assert
- gomonkey (Mock æ¡†æ¶)
- gomock

---

## 3. ç¯å¢ƒè¦æ±‚

### 3.1 åŸºç¡€ç¯å¢ƒ

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|-----|---------|------|
| Cursor IDE | æœ€æ–°ç‰ˆæœ¬ | æ”¯æŒ MCP çš„ AI ç¼–è¾‘å™¨ |
| Go | 1.17+ | é¡¹ç›®ä¾èµ–çš„ Go ç‰ˆæœ¬ |
| Git | 2.0+ | ç‰ˆæœ¬æ§åˆ¶å·¥å…· |

### 3.2 MCP æœåŠ¡é…ç½®

ç¡®ä¿ Cursor çš„ MCP é…ç½®ä¸­å·²æ·»åŠ  Code Guardian æœåŠ¡ï¼š

```json
{
  "mcpServers": {
    "code-guardian": {
      "command": "node",
      "args": ["/path/to/code-guardian/server.js"],
      "env": {
        "API_TOKEN": "your-api-token"
      }
    }
  }
}
```

### 3.3 é¡¹ç›®ä¾èµ–

ç¡®ä¿é¡¹ç›®ä¸­å®‰è£…äº†å¿…è¦çš„æµ‹è¯•ä¾èµ–ï¼š

```bash
# gomonkey - Mock æ¡†æ¶
go get github.com/agiledragon/gomonkey/v2

# testify - æ–­è¨€åº“
go get github.com/stretchr/testify
```

---

## 4. å·¥å…·ä½¿ç”¨æ–¹æ³•

### 4.1 æ ‡å‡†ä½¿ç”¨æµç¨‹

#### æ­¥éª¤ 1: å¯åŠ¨å¯¹è¯å¹¶æä¾›å‚æ•°

å‘ AI å‘é€ä»¥ä¸‹æ ¼å¼çš„è¯·æ±‚ï¼š

```
ä½¿ç”¨ code_guardian MCP å·¥å…·ç”Ÿæˆå•å…ƒæµ‹è¯•ï¼Œæ‰§è¡Œå®Œæ•´æµç¨‹ï¼š

## å‚æ•°
git_repo: <å®Œæ•´ä»“åº“è·¯å¾„>
git_branch: <æºåˆ†æ”¯å>
work_path: <æœ¬åœ°å·¥ä½œç›®å½•>
target_branch: <ç›®æ ‡åˆ†æ”¯å>
env: <ç¯å¢ƒ: test/staging/prod>
ssc_org_id: <SSC ç»„ç»‡ ID>
pfb: <PFB å‚æ•°>

## è¦æ±‚
1. ä½¿ç”¨ MCP Tool å®Œæˆå…¨æµç¨‹ï¼šè·å–è¦†ç›–ç‡ â†’ ç”Ÿæˆæµ‹è¯• â†’ æœ¬åœ°æ‰§è¡Œ â†’ pushä»£ç  â†’ è§¦å‘DMSä»»åŠ¡ â†’ ä¸ŠæŠ¥Aura
2. ä¸¥ç¦è‡ªè¯é¢„è¨€æµ‹è¯•ï¼šæµ‹è¯•æ–‡ä»¶å¿…é¡»ä¸è¢«æµ‹ä»£ç åŒç›®å½•åŒåŒ…ï¼Œå¿…é¡»å®é™…è°ƒç”¨è¢«æµ‹å‡½æ•°å¹¶éªŒè¯è¿”å›å€¼
3. éµå¾ª 2-2-1 åŸåˆ™ï¼šè‡³å°‘ 2 æˆåŠŸ + 2 å¤±è´¥ + 1 è¾¹ç•Œåœºæ™¯
```

#### æ­¥éª¤ 2: AI è‡ªåŠ¨æ‰§è¡Œå®Œæ•´æµç¨‹

AI å°†ä¾æ¬¡è°ƒç”¨ä»¥ä¸‹ MCP å·¥å…·ï¼š

| æ­¥éª¤ | å·¥å…· | è¯´æ˜ |
|-----|------|------|
| 1 | `validate_and_confirm` | éªŒè¯å‚æ•° |
| 2 | `get_and_parse_uncovered_blocks` | è·å–æœªè¦†ç›–ä»£ç  |
| 3 | `generate_test_file` + `write_test_code` | ç”Ÿæˆæµ‹è¯•ä»£ç  |
| 4 | `execute_test` | æœ¬åœ°æ‰§è¡ŒéªŒè¯ |
| 5 | `push_to_repo` | æ¨é€ä»£ç ï¼ˆéœ€ç¡®è®¤ï¼‰ |
| 6 | `trigger_dms_task` | è§¦å‘ DMS ä»»åŠ¡ |
| 7 | `report_usage_to_aura` | ä¸ŠæŠ¥æ•°æ®åˆ° Aura |
| 8 | `generate_summary` | ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š |

### 4.2 å‚æ•°è¯´æ˜

| å‚æ•°å | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|-----|------|------|
| `git_repo` | âœ… | Git ä»“åº“å®Œæ•´è·¯å¾„ | `shopee/bg-logistics/spx/fulfillment/fulfillment-service` |
| `git_branch` | âœ… | æºåˆ†æ”¯å | `feature/SPXFM-186041-location-update` |
| `work_path` | âœ… | æœ¬åœ°å·¥ä½œç›®å½•ç»å¯¹è·¯å¾„ | `/Users/xxx/code/fulfillment-service` |
| `target_branch` | âœ… | ç›®æ ‡åˆ†æ”¯ï¼ˆé€šå¸¸ä¸æºåˆ†æ”¯ç›¸åŒï¼‰ | `feature/SPXFM-186041-location-update` |
| `env` | âœ… | ç¯å¢ƒæ ‡è¯† | `test`, `staging`, `prod` |
| `ssc_org_id` | âœ… | SSC ç»„ç»‡ ID | `27` |
| `pfb` | æ¨è | PFB å‚æ•°ï¼Œç”¨äº DMS ä»»åŠ¡ç­›é€‰ | `pfb-dms-qa-vn-location-update` |

---

## 5. ä½¿ç”¨ç¤ºä¾‹

### 5.1 å®Œæ•´ç¤ºä¾‹ï¼šfulfillment-service ä»“åº“

#### 5.1.1 åˆå§‹è¯·æ±‚

```
ä½¿ç”¨ code_guardian MCP å·¥å…·ç”Ÿæˆå•å…ƒæµ‹è¯•ï¼Œæ‰§è¡Œå®Œæ•´æµç¨‹ï¼š

## å‚æ•°
git_repo: shopee/bg-logistics/spx/fulfillment/fulfillment-service
git_branch: feature/SPXFM-186041-location-update
work_path: /Users/jiaxuan.han/code/dev_project/fulfillment-service
target_branch: feature/SPXFM-186041-location-update
env: test
ssc_org_id: 27
pfb: pfb-dms-qa-vn-location-update

## è¦æ±‚
1. ä½¿ç”¨ MCP Tool å®Œæˆå…¨æµç¨‹ï¼šè·å–è¦†ç›–ç‡ â†’ ç”Ÿæˆæµ‹è¯• â†’ æœ¬åœ°æ‰§è¡Œ â†’ pushä»£ç  â†’ è§¦å‘DMSä»»åŠ¡ â†’ ä¸ŠæŠ¥Aura
2. ä¸¥ç¦è‡ªè¯é¢„è¨€æµ‹è¯•ï¼šæµ‹è¯•æ–‡ä»¶å¿…é¡»ä¸è¢«æµ‹ä»£ç åŒç›®å½•åŒåŒ…ï¼Œå¿…é¡»å®é™…è°ƒç”¨è¢«æµ‹å‡½æ•°å¹¶éªŒè¯è¿”å›å€¼
3. éµå¾ª 2-2-1 åŸåˆ™ï¼šè‡³å°‘ 2 æˆåŠŸ + 2 å¤±è´¥ + 1 è¾¹ç•Œåœºæ™¯
```

#### 5.1.2 æ‰§è¡Œè¿‡ç¨‹

**ç¬¬ä¸€é˜¶æ®µï¼šå‚æ•°éªŒè¯**

AI è°ƒç”¨ `validate_and_confirm` å·¥å…·éªŒè¯æ‰€æœ‰å‚æ•°ï¼š

```json
{
  "git_repo": "shopee/bg-logistics/spx/fulfillment/fulfillment-service",
  "git_branch": "feature/SPXFM-186041-location-update",
  "target_branch": "feature/SPXFM-186041-location-update",
  "env": "test",
  "ssc_org_id": "27",
  "pfb": "pfb-dms-qa-vn-location-update"
}
```

**ç¬¬äºŒé˜¶æ®µï¼šè·å–æœªè¦†ç›–ä»£ç å—**

AI è°ƒç”¨ `get_and_parse_uncovered_blocks` è·å–è¦†ç›–ç‡æ•°æ®ï¼š

```
è¯†åˆ«åˆ° 6 ä¸ªæœªè¦†ç›–çš„ä»£ç å—ï¼š
1. apps/order/business/update_destination.go:360-386
2. apps/order/business/update_destination.go:441-447
3. thirdparty/site/site_network_router/address_service.go:163-174
4. thirdparty/site/site_network_router/base_service.go:516-531
5. apps/order/schema/order_grpc.go:7440-7465
6. apps/order/service/solution/network_solution.go:2114-2188
```

**ç¬¬ä¸‰é˜¶æ®µï¼šç”Ÿæˆæµ‹è¯•æ–‡ä»¶**

AI è°ƒç”¨ `generate_test_file` ç”Ÿæˆæµ‹è¯•æ¡†æ¶ï¼Œç„¶åä½¿ç”¨ `write_test_code` å†™å…¥æµ‹è¯•ä»£ç ã€‚

**é‡è¦æç¤º**ï¼šæµ‹è¯•æ–‡ä»¶å¿…é¡»ä¸è¢«æµ‹ä»£ç åœ¨åŒä¸€ç›®å½•ä¸‹ï¼ˆåŒåŒ…ï¼‰ï¼Œè€Œä¸æ˜¯ç‹¬ç«‹çš„ `test/` ç›®å½•ã€‚

âœ… **æ­£ç¡®ä½ç½®**:
```
thirdparty/site/site_network_router/address_service_test.go
```

âŒ **é”™è¯¯ä½ç½®**:
```
test/thirdparty/site/site_network_router/address_service_test.go
```

**ç¬¬å››é˜¶æ®µï¼šæ‰§è¡Œæµ‹è¯•**

AI è°ƒç”¨ `execute_test` æ‰§è¡Œæœ¬åœ°æµ‹è¯•ï¼š

```bash
go test -gcflags=all=-l -v -coverprofile=coverage.out ./thirdparty/site/site_network_router/...
```

æµ‹è¯•ç»“æœï¼š
```
=== RUN   TestGetLowestAddressNameByAddressId
--- PASS: TestGetLowestAddressNameByAddressId (0.00s)
    --- PASS: success_get_address_name
    --- PASS: success_address_not_in_mapping
    --- PASS: success_nil_mapping
    --- PASS: error_get_mapping_failed
    --- PASS: boundary_zero_address_id
PASS
coverage: 1.4% of statements
```

**ç¬¬äº”é˜¶æ®µï¼šæ¨é€ä»£ç **

AI è°ƒç”¨ `push_to_repo` æ¨é€ä»£ç ï¼š

```json
{
  "status": "success",
  "branch": "feature/SPXFM-186041-location-update",
  "message": "Code pushed successfully"
}
```

#### 5.1.3 æœ€ç»ˆç»“æœ

| æŒ‡æ ‡ | ç»“æœ |
|-----|------|
| ç”Ÿæˆæµ‹è¯•æ–‡ä»¶ | 1 ä¸ª |
| æµ‹è¯•ç”¨ä¾‹æ•° | 7 ä¸ª |
| æµ‹è¯•é€šè¿‡ç‡ | 100% |
| è¦†ç›–ç‡æå‡ | 1.4% |
| è¦†ç›–å‡½æ•° | `GetLowestAddressNameByAddressId`, `GetLowestAddressIdNameMapping` |

### 5.1.4 ç”Ÿæˆçš„æµ‹è¯•ä»£ç ç¤ºä¾‹

```go
package site_network_router // <ai-gen>

import ( // <ai-gen>
    "context" // <ai-gen>
    "errors" // <ai-gen>
    "reflect" // <ai-gen>
    "testing" // <ai-gen>

    "git.garena.com/shopee/bg-logistics/spx/network-route/network-route-protobuf/pkg/address" // <ai-gen>

    "github.com/agiledragon/gomonkey/v2" // <ai-gen>
    "github.com/stretchr/testify/assert" // <ai-gen>
) // <ai-gen>

func TestGetLowestAddressNameByAddressId(t *testing.T) { // <ai-gen>
    tests := []struct { // <ai-gen>
        name            string            // <ai-gen>
        addressId       uint64            // <ai-gen>
        mockMapping     map[uint64]string // <ai-gen>
        mockErr         error             // <ai-gen>
        wantAddressName string            // <ai-gen>
        wantErr         bool              // <ai-gen>
    }{ // <ai-gen>
        { // <ai-gen>
            name:            "success_get_address_name", // <ai-gen>
            addressId:       12345, // <ai-gen>
            mockMapping:     map[uint64]string{12345: "District Name"}, // <ai-gen>
            mockErr:         nil, // <ai-gen>
            wantAddressName: "District Name", // <ai-gen>
            wantErr:         false, // <ai-gen>
        }, // <ai-gen>
        // ... æ›´å¤šæµ‹è¯•ç”¨ä¾‹
    } // <ai-gen>

    for _, tc := range tests { // <ai-gen>
        t.Run(tc.name, func(t *testing.T) { // <ai-gen>
            patches := gomonkey.NewPatches() // <ai-gen>
            defer patches.Reset() // <ai-gen>

            facade := &SiteNetworkRouteFacade{serviceName: "test-service"} // <ai-gen>

            patches.ApplyMethod(reflect.TypeOf(facade), "GetLowestAddressIdNameMapping", // <ai-gen>
                func(_ *SiteNetworkRouteFacade, _ context.Context, _ *address.GetLowestAddressIdNameMappingReq) (map[uint64]string, error) { // <ai-gen>
                    return tc.mockMapping, tc.mockErr // <ai-gen>
                }) // <ai-gen>

            ctx := context.Background() // <ai-gen>
            result, err := facade.GetLowestAddressNameByAddressId(ctx, tc.addressId) // <ai-gen>

            if tc.wantErr { // <ai-gen>
                assert.Error(t, err) // <ai-gen>
            } else { // <ai-gen>
                assert.NoError(t, err) // <ai-gen>
                assert.Equal(t, tc.wantAddressName, result) // <ai-gen>
            } // <ai-gen>
        }) // <ai-gen>
    } // <ai-gen>
} // <ai-gen>
```
### 5.2 ç¤ºä¾‹ï¼šfleetorder-service ä»“åº“ï¼ˆé—®é¢˜æ¡ˆä¾‹ï¼‰

#### 5.2.1 åˆå§‹è¯·æ±‚

```
ä½¿ç”¨ code_guardian ç”Ÿæˆå•å…ƒæµ‹è¯•ï¼š

git_repo: shopee/bg-logistics/spx/order-center/fleetorder-service
git_branch: feature/SPXFM-186041-location-update
work_path: /Users/jiaxuan.han/code/dev_project/fleetorder-service
target_branch: feature/SPXFM-186041-location-update
env: test
ssc_org_id: 27
pfb: pfb-dms-qa-vn-location-update
```

#### 5.2.2 æ‰§è¡Œè¿‡ç¨‹

**ç¬¬ä¸€é˜¶æ®µï¼šè·å–æœªè¦†ç›–ä»£ç å—**

è¯†åˆ«åˆ° 5 ä¸ªéœ€è¦è¦†ç›–çš„ä»£ç å—ï¼š

| åºå· | æ–‡ä»¶è·¯å¾„ | è¡Œå· | æè¿° |
|-----|---------|------|------|
| 1 | `apps/order/service/order_tracking_list.go` | 100-145 | `calcBandSLowestAddressName` åˆ†æ”¯é€»è¾‘ |
| 2 | `apps/order/schema/order_grpc.go` | 4068-4080 | `GetFleetOrderInfoList` åœ°å€è§£ææˆåŠŸè·¯å¾„ |
| 3 | `apps/order/schema/order_grpc.go` | 4274-4286 | `BatchGetFleetOrderInfoList` åœ°å€è§£ææˆåŠŸè·¯å¾„ |
| 4 | `apps/order/service/order.go` | 1234-1260 | `ParseAddress` æ–¹æ³• |
| 5 | `apps/track/service/service_point_track_handler.go` | 130-132 | JSON è§£æé”™è¯¯åˆ†æ”¯ |

**ç¬¬äºŒé˜¶æ®µï¼šç”Ÿæˆæµ‹è¯•ç”¨ä¾‹**

æˆåŠŸç”Ÿæˆ 3 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œå…±è®¡ 15+ ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

| æµ‹è¯•æ–‡ä»¶ | æµ‹è¯•å‡½æ•°æ•° | è¦†ç›–çš„ä»£ç å— |
|---------|-----------|-------------|
| `apps/order/service/order_tracking_list_test.go` | 8 | calcBandSLowestAddressName å¤šä¸ªåˆ†æ”¯ |
| `apps/order/schema/order_grpc_test.go` | 4 | GetFleetOrderInfoList, BatchGetFleetOrderInfoList |
| `apps/track/service/service_point_track_handler_test.go` | 2 | AppendSPDopReceiveUpdateFieldsNew |

**ç¬¬ä¸‰é˜¶æ®µï¼šæœ¬åœ°æµ‹è¯•æ‰§è¡Œ**

```bash
go test -gcflags=all=-l -v ./apps/order/schema/...
go test -gcflags=all=-l -v ./apps/order/service/...
go test -gcflags=all=-l -v ./apps/track/service/...
```

ç»“æœï¼šâœ… **æ‰€æœ‰æµ‹è¯•æœ¬åœ°é€šè¿‡**

```
ok      fleetorder/apps/order/schema    10.070s
ok      fleetorder/apps/order/service   7.206s
ok      fleetorder/apps/track/service   6.914s
```

**ç¬¬å››é˜¶æ®µï¼šDMS æ‰§è¡Œå¤±è´¥** âŒ

æ¨é€ä»£ç åˆ°è¿œç¨‹ä»“åº“åï¼ŒDMS æ‰§è¡Œæµ‹è¯•æ—¶å‡ºç° panicï¼š

```
--- FAIL: TestServicePointGrpcSchema_GetFleetOrderInfoList_ParseAddressSuccess (0.08s)
panic: InitConfig error,CHASSIS_CONF_DIR:/workspace/gitlab/fleetorder-service/conf/http_server/SPX-FleetOrderService
```

#### 5.2.3 é—®é¢˜åˆ†æ

| å¯¹æ¯”é¡¹ | æœ¬åœ°ç¯å¢ƒ | DMS ç¯å¢ƒ |
|-------|---------|---------|
| æ“ä½œç³»ç»Ÿ | macOS (darwin) | Linux |
| å·¥ä½œç›®å½• | `/Users/xxx/code/fleetorder-service` | `/workspace/gitlab/fleetorder-service-xxx-for-run` |
| é…ç½®æ–‡ä»¶ | âœ… å­˜åœ¨ | âŒ ä¸å­˜åœ¨æˆ–è·¯å¾„ä¸åŒ¹é… |
| `lib.InitTestChassis()` | âœ… åˆå§‹åŒ–æˆåŠŸ | âŒ panic |

**æ ¹æœ¬åŸå› **ï¼š

`lib.InitTestChassis()` å‡½æ•°é€šè¿‡ä»¥ä¸‹é€»è¾‘æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼š

```go
home, _ := os.Getwd()
index := strings.Index(home, "/fleetorder-service")
if index > 0 {
    home = SubString(home, 0, index) + "/fleetorder-service"
}
chassisPath := path.Join(home, "/conf/http_server/SPX-FleetOrderService")
```

åœ¨ DMS ç¯å¢ƒä¸­ï¼Œå·¥ä½œç›®å½•æ˜¯ `/workspace/gitlab/fleetorder-service-46c33d4ec0df063ed1c48e02464dde2002a140c9-for-run`ï¼Œé…ç½®æ–‡ä»¶è·¯å¾„æŸ¥æ‰¾é€»è¾‘å¤±è´¥ã€‚

#### 5.2.4 è§£å†³æ–¹æ¡ˆï¼ˆå¾…å®æ–½ï¼‰

**æ–¹æ¡ˆä¸€ï¼šä¿®æ”¹æµ‹è¯•åˆå§‹åŒ–é€»è¾‘**

é¿å…åœ¨æµ‹è¯•ä¸­ç›´æ¥è°ƒç”¨ `lib.InitTestChassis()`ï¼Œæ”¹ä¸ºåªåˆå§‹åŒ–å¿…è¦çš„é…ç½®ï¼š

```go
// âŒ é¿å…ï¼šç›´æ¥è°ƒç”¨ InitTestChassis
lib.InitTestChassis()

// âœ… æ¨èï¼šåªåˆå§‹åŒ–å¿…è¦é…ç½®
lib.CommonConfig = &lib.ConfigOptions{IConfig: lib.ConfigCenter{}}
```

**æ–¹æ¡ˆäºŒï¼šä¿®æ”¹ lib.InitTestChassis() å®¹é”™é€»è¾‘**

ä¿®æ”¹ `lib/test_env_config.go`ï¼Œä½¿å…¶åœ¨åˆå§‹åŒ–å¤±è´¥æ—¶ä¸ panicï¼š

```go
err := chassis.Init()
if err != nil {
    // ä¸å† panicï¼Œæ”¹ä¸ºé™çº§å¤„ç†
    fmt.Printf("WARNING: InitConfig error, using fallback config\n")
    CommonConfig = &ConfigOptions{IConfig: ConfigCenter{}}
    return
}
```

#### 5.2.5 ç»éªŒæ€»ç»“

| è¦ç‚¹ | è¯´æ˜ |
|-----|------|
| ğŸ”´ **ç¯å¢ƒå·®å¼‚** | æœ¬åœ°æµ‹è¯•é€šè¿‡ä¸ä»£è¡¨ DMS ä¸€å®šé€šè¿‡ï¼Œéœ€æ³¨æ„ç¯å¢ƒå·®å¼‚ |
| ğŸ”´ **é…ç½®ä¾èµ–** | æµ‹è¯•åº”å°½é‡å‡å°‘å¯¹å¤–éƒ¨é…ç½®æ–‡ä»¶çš„ä¾èµ– |
| ğŸŸ¡ **åˆå§‹åŒ–å‡½æ•°** | ä½¿ç”¨ `lib.InitTestChassis()` å‰éœ€ç¡®è®¤ DMS å…¼å®¹æ€§ |
| ğŸŸ¢ **Mock ç­–ç•¥** | é€šè¿‡å®Œå–„çš„ Mock å¯ä»¥é¿å…å¯¹çœŸå®é…ç½®çš„ä¾èµ– |

---

## 6. æœ€ä½³å®è·µ

### 6.1 æµ‹è¯•æ–‡ä»¶ä½ç½®è§„èŒƒ

| è§„åˆ™ | è¯´æ˜ |
|-----|------|
| **åŒç›®å½•åŸåˆ™** | æµ‹è¯•æ–‡ä»¶å¿…é¡»ä¸è¢«æµ‹ä»£ç åœ¨åŒä¸€ç›®å½• |
| **åŒåŒ…åŸåˆ™** | æµ‹è¯•æ–‡ä»¶çš„ package å¿…é¡»ä¸è¢«æµ‹ä»£ç ç›¸åŒ |
| **å‘½åè§„èŒƒ** | æµ‹è¯•æ–‡ä»¶å‘½å: `{source_file}_test.go` |

### 6.2 Mock ç­–ç•¥

#### æ¨èçš„ Mock å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è¢«æµ‹å‡½æ•°                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… Mock è¿™ä¸€å±‚: ç›´æ¥ä¾èµ–çš„æ–¹æ³•             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âŒ ä¸è¦ Mock: åº•å±‚å®ç°ç»†èŠ‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Mock ç¤ºä¾‹

```go
// âœ… æ¨èï¼šMock Facade çš„å…¬å¼€æ–¹æ³•
patches.ApplyMethod(reflect.TypeOf(facade), "GetLowestAddressIdNameMapping",
    func(_ *SiteNetworkRouteFacade, ...) (map[uint64]string, error) {
        return mockData, nil
    })

// âŒ é¿å…ï¼šMock ç§æœ‰ç±»å‹çš„åº•å±‚æ–¹æ³•
patches.ApplyMethod(reflect.TypeOf(client.Grpc), "Invoke", ...)
```

### 6.3 æµ‹è¯•ç”¨ä¾‹è¦†ç›–åŸåˆ™

éµå¾ª **2-2-1** åŸåˆ™ï¼š

| åœºæ™¯ç±»å‹ | æœ€å°‘æ•°é‡ | è¯´æ˜ |
|---------|---------|------|
| æˆåŠŸåœºæ™¯ | â‰¥2 | æ­£å¸¸æ•°æ® + è¾¹ç•Œæ•°æ® |
| å¤±è´¥åœºæ™¯ | â‰¥2 | å‚æ•°é”™è¯¯ + å¤–éƒ¨ä¾èµ–å¤±è´¥ |
| è¾¹ç•Œåœºæ™¯ | â‰¥1 | ç©ºå€¼/é›¶å€¼/æå€¼ |

---

## 7. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 7.1 è‡ªè¯é¢„è¨€æµ‹è¯•ï¼ˆSelf-fulfilling Prophecy Testsï¼‰

**é—®é¢˜ç°è±¡**ï¼š
- æµ‹è¯•é€šè¿‡ä½†è¦†ç›–ç‡ä¸º 0%
- DMS æ—¥å¿—æ˜¾ç¤º `coverage: [no statements]`

**é—®é¢˜åŸå› **ï¼š
- æµ‹è¯•æ–‡ä»¶ä¸è¢«æµ‹ä»£ç ä¸åœ¨åŒä¸€ä¸ªåŒ…
- æµ‹è¯•åªéªŒè¯äº† Mock è®¾ç½®ï¼Œæ²¡æœ‰å®é™…è°ƒç”¨è¢«æµ‹å‡½æ•°

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å°†æµ‹è¯•æ–‡ä»¶ç§»åŠ¨åˆ°ä¸è¢«æµ‹ä»£ç ç›¸åŒçš„ç›®å½•
2. ç¡®ä¿æµ‹è¯•ä¸­å®é™…è°ƒç”¨äº†è¢«æµ‹å‡½æ•°
3. éªŒè¯è¿”å›å€¼è€Œä¸ä»…ä»…æ˜¯ Mock æ˜¯å¦è¢«è°ƒç”¨

### 7.2 Mock ç§æœ‰ç±»å‹å¤±è´¥

**é—®é¢˜ç°è±¡**ï¼š
```
panic: retrieve method by name failed
```

**é—®é¢˜åŸå› **ï¼š
- å°è¯• Mock çš„ç±»å‹æ˜¯ç§æœ‰çš„ï¼ˆå°å†™å¼€å¤´ï¼‰
- `ApplyMethodReturn` ä¸æ”¯æŒç§æœ‰ç±»å‹

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ”¹ä¸º Mock å…¬å¼€çš„ Facade æ–¹æ³•
2. æˆ–åœ¨è¢«æµ‹åŒ…å†…åˆ›å»º Mock å¯¹è±¡

### 7.3 Chassis åˆå§‹åŒ– Panic

**é—®é¢˜ç°è±¡**ï¼š
```
panic: InitConfig error, CHASSIS_CONF_DIR: ...
```

**é—®é¢˜åŸå› **ï¼š
- æµ‹è¯•ç¯å¢ƒç¼ºå°‘ Chassis é…ç½®æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. Mock ä¾èµ– Chassis çš„æ–¹æ³•
2. æˆ–ä½¿ç”¨ `lib.InitTestChassis()` åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ

### 7.4 æœ¬åœ°æµ‹è¯•é€šè¿‡ä½† DMS æ‰§è¡Œå¤±è´¥

**é—®é¢˜ç°è±¡**ï¼š
- æœ¬åœ°æ‰§è¡Œ `go test` å…¨éƒ¨é€šè¿‡
- æ¨é€åˆ°è¿œç¨‹åï¼ŒDMS æ‰§è¡Œæ—¶æµ‹è¯• panic æˆ–å¤±è´¥

**å…¸å‹é”™è¯¯ä¿¡æ¯**ï¼š
```
panic: InitConfig error,CHASSIS_CONF_DIR:/workspace/gitlab/xxx-service/conf/http_server/SPX-XXXService

[chassis_test_vn.yaml] not exist
[chassis_test.yaml] not exist
[chassis.yaml] not exist
```

**é—®é¢˜åŸå› **ï¼š

| åŸå› ç±»å‹ | è¯¦ç»†è¯´æ˜ |
|---------|---------|
| **ç›®å½•ç»“æ„å·®å¼‚** | DMS ç¯å¢ƒçš„å·¥ä½œç›®å½•ç»“æ„ä¸æœ¬åœ°ä¸åŒï¼Œé€šå¸¸æ ¼å¼ä¸º `/workspace/gitlab/{repo}-{hash}-for-run/` |
| **é…ç½®æ–‡ä»¶ç¼ºå¤±** | DMS ç¯å¢ƒä¸­å¯èƒ½æ²¡æœ‰å¤åˆ¶é¡¹ç›®çš„é…ç½®æ–‡ä»¶ç›®å½• |
| **è·¯å¾„æŸ¥æ‰¾é€»è¾‘** | `lib.InitTestChassis()` çš„è·¯å¾„æŸ¥æ‰¾é€»è¾‘å‡è®¾ç›®å½•ååŒ…å« `/fleetorder-service`ï¼Œä½† DMS ç›®å½•åå¸¦æœ‰ hash åç¼€ |
| **æ“ä½œç³»ç»Ÿå·®å¼‚** | æœ¬åœ°æ˜¯ macOS/Windowsï¼ŒDMS æ˜¯ Linux |

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆä¸€ï¼ˆæ¨èï¼‰ï¼šé¿å…ä½¿ç”¨ InitTestChassis**

```go
// âŒ ä¸è¦è¿™æ ·åš
func TestXxx(t *testing.T) {
    lib.InitTestChassis()  // åœ¨ DMS ä¸­ä¼š panic
    // ...
}

// âœ… æ¨èåšæ³•ï¼šç›´æ¥åˆå§‹åŒ–å¿…è¦çš„é…ç½®
func TestXxx(t *testing.T) {
    lib.CommonConfig = &lib.ConfigOptions{IConfig: lib.ConfigCenter{}}
    // ç„¶å Mock æ‰€æœ‰éœ€è¦çš„æ–¹æ³•
    patches := gomonkey.NewPatches()
    defer patches.Reset()
    // ...
}
```

**æ–¹æ¡ˆäºŒï¼šæ·»åŠ  DMS ç¯å¢ƒæ£€æµ‹**

```go
import "runtime"

// inDms æ£€æµ‹æ˜¯å¦åœ¨ DMS ç¯å¢ƒä¸­è¿è¡Œ
func inDms() bool {
    return runtime.GOOS != "darwin" && runtime.GOOS != "windows"
}

func TestXxx(t *testing.T) {
    if inDms() {
        t.Skip("Skip in DMS environment: requires chassis config")
    }
    lib.InitTestChassis()
    // ...
}
```

**æ–¹æ¡ˆä¸‰ï¼šå®Œå–„ Mock è¦†ç›–**

å¦‚æœæµ‹è¯•å¿…é¡»è°ƒç”¨ `lib.InitTestChassis()`ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ– Chassis é…ç½®çš„æ–¹æ³•éƒ½è¢« Mockï¼š

```go
func TestXxx(t *testing.T) {
    patches := gomonkey.NewPatches()
    defer patches.Reset()
    
    // Mock chassis.Init é¿å…åˆå§‹åŒ–å¤±è´¥
    patches.ApplyFunc(chassis.Init, func(...chassis.Option) error {
        return nil
    })
    
    // æ‰‹åŠ¨åˆå§‹åŒ–å¿…è¦é…ç½®
    lib.CommonConfig = &lib.ConfigOptions{IConfig: lib.ConfigCenter{}}
    
    // ... å…¶ä»–æµ‹è¯•é€»è¾‘
}
```

**æœ€ä½³å®è·µ**ï¼š

| å®è·µ | è¯´æ˜ |
|-----|------|
| âœ… å®Œå–„ Mock | å°½é‡ Mock æ‰€æœ‰å¤–éƒ¨ä¾èµ–ï¼Œå‡å°‘å¯¹çœŸå®é…ç½®çš„ä¾èµ– |
| âœ… ç¯å¢ƒæ— å…³ | æµ‹è¯•ä»£ç åº”å°½é‡åšåˆ°ç¯å¢ƒæ— å…³ |
| âœ… æœ€å°ä¾èµ– | åªåˆå§‹åŒ–æµ‹è¯•å¿…éœ€çš„æœ€å°é…ç½®é›† |
| âš ï¸ è°¨æ…ä½¿ç”¨ | è°¨æ…ä½¿ç”¨ `lib.InitTestChassis()` ç­‰å…¨å±€åˆå§‹åŒ–å‡½æ•° |

### 7.5 åŒ…çº§åˆå§‹åŒ–å¯¼è‡´æµ‹è¯• panic

**é—®é¢˜ç°è±¡**ï¼š
- åœ¨åŒä¸€ä¸ªåŒ…ä¸­æ·»åŠ æ–°æµ‹è¯•åï¼Œæ•´ä¸ªåŒ…çš„æµ‹è¯•éƒ½å¤±è´¥
- panic å‘ç”Ÿåœ¨ `init()` å‡½æ•°æˆ–åŒ…çº§å˜é‡åˆå§‹åŒ–ä¸­

**å…¸å‹åœºæ™¯**ï¼š

```go
// track_service_test.go
var trackService = initService()  // åŒ…çº§å˜é‡åœ¨å¯¼å…¥æ—¶åˆå§‹åŒ–

func initService() *TrackService {
    lib.InitTestChassis()  // å¦‚æœè¿™é‡Œ panicï¼Œæ•´ä¸ªåŒ…çš„æµ‹è¯•éƒ½ä¼šå¤±è´¥
    // ...
}
```

**é—®é¢˜åŸå› **ï¼š
- Go çš„åŒ…çº§å˜é‡åœ¨åŒ…è¢«å¯¼å…¥æ—¶ç«‹å³åˆå§‹åŒ–
- å¦‚æœåŒ…ä¸­ä»»ä¸€æµ‹è¯•æ–‡ä»¶æœ‰åŒ…çº§åˆå§‹åŒ–é€»è¾‘ï¼Œä¼šå½±å“æ•´ä¸ªåŒ…çš„æ‰€æœ‰æµ‹è¯•
- å³ä½¿æ–°æ·»åŠ çš„æµ‹è¯•ä¸ä¾èµ–è¯¥åˆå§‹åŒ–é€»è¾‘ï¼Œä¹Ÿä¼šè¢«å½±å“

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **é¿å…åœ¨åŒ…çº§å˜é‡ä¸­è°ƒç”¨å¯èƒ½å¤±è´¥çš„åˆå§‹åŒ–å‡½æ•°**

```go
// âŒ é¿å…
var trackService = initService()

// âœ… æ¨èï¼šå»¶è¿Ÿåˆå§‹åŒ–
var trackService *TrackService
var initOnce sync.Once

func getTrackService() *TrackService {
    initOnce.Do(func() {
        if !inDms() {
            trackService = initService()
        }
    })
    return trackService
}
```

2. **å°†æµ‹è¯•æ–‡ä»¶æ‹†åˆ†åˆ°ä¸åŒå­åŒ…**

é¿å…æ–°æµ‹è¯•å—ç°æœ‰åŒ…çº§åˆå§‹åŒ–çš„å½±å“ã€‚

---

## 8. ä¼˜åŒ–å»ºè®®

### 8.1 æç¤ºè¯ä¼˜åŒ–

#### 8.1.1 é¿å…è‡ªè¯é¢„è¨€æµ‹è¯•

**å»ºè®®æ·»åŠ åˆ° AI æç¤ºè¯**ï¼š

```markdown
## å…³é”®æµ‹è¯•è§„èŒƒ

1. **æµ‹è¯•æ–‡ä»¶ä½ç½®**ï¼šæµ‹è¯•æ–‡ä»¶å¿…é¡»ä¸è¢«æµ‹ä»£ç åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œä½¿ç”¨ç›¸åŒçš„ package å

2. **ç¦æ­¢è‡ªè¯é¢„è¨€æµ‹è¯•**ï¼š
   - âŒ ç¦æ­¢ï¼šæµ‹è¯•åªéªŒè¯ Mock æ˜¯å¦è¢«è®¾ç½®
   - âœ… å¿…é¡»ï¼šå®é™…è°ƒç”¨è¢«æµ‹å‡½æ•°å¹¶éªŒè¯è¿”å›å€¼
   
3. **Mock å±‚çº§é€‰æ‹©**ï¼š
   - âœ… ä¼˜å…ˆ Mock è¢«æµ‹å‡½æ•°çš„ç›´æ¥ä¾èµ–
   - âŒ é¿å… Mock ç§æœ‰ç±»å‹çš„åº•å±‚å®ç°
```

#### 8.1.2 å¢å¼ºæµ‹è¯•ç”Ÿæˆè´¨é‡

```markdown
## æµ‹è¯•ç”Ÿæˆæ£€æŸ¥æ¸…å•

åœ¨ç”Ÿæˆæµ‹è¯•å‰ï¼ŒAI å¿…é¡»ç¡®è®¤ï¼š
- [ ] æµ‹è¯•æ–‡ä»¶ä¸è¢«æµ‹ä»£ç åœ¨åŒä¸€ç›®å½•
- [ ] ä½¿ç”¨ `t.Run()` æ‰§è¡Œå­æµ‹è¯•
- [ ] æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹éƒ½å®é™…è°ƒç”¨è¢«æµ‹å‡½æ•°
- [ ] æ–­è¨€éªŒè¯è¿”å›å€¼è€Œé Mock è°ƒç”¨
- [ ] åŒ…å«è‡³å°‘ 2 ä¸ªæˆåŠŸã€2 ä¸ªå¤±è´¥ã€1 ä¸ªè¾¹ç•Œåœºæ™¯
```

#### 8.1.3 DMS ç¯å¢ƒå…¼å®¹æ€§æ£€æŸ¥

```markdown
## DMS ç¯å¢ƒå…¼å®¹æ€§æ£€æŸ¥æ¸…å•

åœ¨ç”Ÿæˆæµ‹è¯•å‰ï¼ŒAI å¿…é¡»æ£€æŸ¥å¹¶ç¡®è®¤ï¼š
- [ ] æµ‹è¯•æ˜¯å¦ä¾èµ– `lib.InitTestChassis()` æˆ–ç±»ä¼¼çš„å…¨å±€åˆå§‹åŒ–å‡½æ•°
- [ ] å¦‚æœä¾èµ–ï¼Œæ˜¯å¦å¯ä»¥é€šè¿‡ Mock æ›¿ä»£
- [ ] å¦‚æœæ— æ³•æ›¿ä»£ï¼Œæ˜¯å¦æ·»åŠ äº† DMS ç¯å¢ƒè·³è¿‡é€»è¾‘
- [ ] æµ‹è¯•æ˜¯å¦ä¾èµ–æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
- [ ] æµ‹è¯•æ˜¯å¦ä¾èµ–ç¯å¢ƒå˜é‡ï¼ˆå¦‚ CHASSIS_CONF_DIRï¼‰

## æ¨èçš„åˆå§‹åŒ–æ¨¡å¼

âŒ é¿å…ä½¿ç”¨å…¨å±€åˆå§‹åŒ–å‡½æ•°ï¼š
```go
lib.InitTestChassis()  // å¯èƒ½åœ¨ DMS ä¸­å¤±è´¥
```

âœ… æ¨èä½¿ç”¨è½»é‡çº§åˆå§‹åŒ–ï¼š
```go
lib.CommonConfig = &lib.ConfigOptions{IConfig: lib.ConfigCenter{}}
// é…åˆå®Œå–„çš„ Mock
```

### 8.2 å·¥å…·æµç¨‹ä¼˜åŒ–

#### 8.2.1 å½“å‰æµç¨‹é—®é¢˜

```
å½“å‰æµç¨‹:
éªŒè¯å‚æ•° â†’ è·å–è¦†ç›–ç‡ â†’ ç”Ÿæˆæµ‹è¯• â†’ æ‰§è¡Œæµ‹è¯• â†’ æ¨é€ä»£ç  â†’ [ç»“æŸ]
                                                    â†‘
                                               ç¼ºå°‘ DMS è§¦å‘å’ŒéªŒè¯
```

#### 8.2.2 å»ºè®®ä¼˜åŒ–åçš„æµç¨‹

```
ä¼˜åŒ–æµç¨‹:
éªŒè¯å‚æ•° â†’ è·å–è¦†ç›–ç‡ â†’ ç”Ÿæˆæµ‹è¯• â†’ æ‰§è¡Œæµ‹è¯• â†’ æ¨é€ä»£ç  
                                            â†“
ç”ŸæˆæŠ¥å‘Š â† è·å–è¦†ç›–ç‡ç»“æœ â† ç­‰å¾… DMS å®Œæˆ â† è§¦å‘ DMS
```

#### 8.2.3 å…·ä½“ä¼˜åŒ–å»ºè®®

| ä¼˜åŒ–é¡¹ | å½“å‰çŠ¶æ€ | å»ºè®®æ”¹è¿› |
|-------|---------|---------|
| DMS è§¦å‘ | éœ€æ‰‹åŠ¨è§¦å‘ | è‡ªåŠ¨è§¦å‘ DMS ä»»åŠ¡ |
| è¦†ç›–ç‡éªŒè¯ | ä»…æœ¬åœ°éªŒè¯ | ç­‰å¾… DMS ç»“æœå¹¶éªŒè¯ |
| å¤±è´¥é‡è¯• | æ—  | æµ‹è¯•å¤±è´¥æ—¶è‡ªåŠ¨ä¿®å¤é‡è¯• |
| è¿›åº¦æ˜¾ç¤º | ç®€å•è¾“å‡º | æ·»åŠ è¿›åº¦æ¡å’ŒçŠ¶æ€æç¤º |
| æŠ¥å‘Šç”Ÿæˆ | åŸºç¡€ä¿¡æ¯ | å¢åŠ è¯¦ç»†çš„ä»£ç å—è¦†ç›–å¯¹æ¯” |

### 8.3 æŠ€æœ¯æ”¹è¿›å»ºè®®

#### 8.3.1 æå‡ Mock èƒ½åŠ›

**é—®é¢˜**ï¼šæ— æ³• Mock ç§æœ‰ç±»å‹ï¼ˆå¦‚ `*grpcClient`ï¼‰

**å»ºè®®**ï¼š
1. åœ¨ `lib/client` åŒ…å†…æ·»åŠ æµ‹è¯•è¾…åŠ©å‡½æ•°
2. ä¸º `grpcClient` æ·»åŠ æ¥å£æŠ½è±¡

```go
// å»ºè®®æ·»åŠ åˆ° lib/client/grpc_client.go
type GrpcInvoker interface {
    Invoke(ctx context.Context, serviceName, schemaID, operationID string, in, out interface{}) error
}

var Grpc GrpcInvoker = newGrpcClient()
```

#### 8.3.2 æ”¹è¿›æµ‹è¯•æ¨¡æ¿

**å½“å‰æ¨¡æ¿é—®é¢˜**ï¼š
- é€šç”¨æ€§ä¸å¤Ÿï¼Œéœ€è¦é’ˆå¯¹ä¸åŒä»£ç ç»“æ„è°ƒæ•´

**å»ºè®®æ”¹è¿›**ï¼š
1. æ·»åŠ æ›´å¤šæµ‹è¯•æ¨¡æ¿ç±»å‹ï¼ˆCRUDã€RPCã€äº‹ä»¶å¤„ç†ç­‰ï¼‰
2. æ ¹æ®å‡½æ•°ç­¾åè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ¨¡æ¿
3. æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿é…ç½®

#### 8.3.3 å¢å¼º DMS ç¯å¢ƒå…¼å®¹æ€§

**é—®é¢˜**ï¼šæœ¬åœ°æµ‹è¯•é€šè¿‡ä½† DMS æ‰§è¡Œå¤±è´¥

**ç°çŠ¶åˆ†æ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æµ‹è¯•æ‰§è¡Œç¯å¢ƒå¯¹æ¯”                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       é¡¹ç›®        â”‚       æœ¬åœ°ç¯å¢ƒ        â”‚        DMS ç¯å¢ƒ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ“ä½œç³»ç»Ÿ          â”‚ macOS/Windows        â”‚ Linux                     â”‚
â”‚ å·¥ä½œç›®å½•          â”‚ /Users/xxx/repo      â”‚ /workspace/gitlab/repo-   â”‚
â”‚                  â”‚                      â”‚ {hash}-for-run/          â”‚
â”‚ é…ç½®æ–‡ä»¶          â”‚ âœ… å®Œæ•´å­˜åœ¨            â”‚ âŒ å¯èƒ½ç¼ºå¤±                â”‚
â”‚ ç¯å¢ƒå˜é‡          â”‚ ç”¨æˆ·å¯æ§               â”‚ DMS é¢„è®¾                 â”‚
â”‚ ç½‘ç»œè®¿é—®          â”‚ å®Œæ•´                  â”‚ å—é™                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å»ºè®®æ”¹è¿›**ï¼š

**1. æ”¹è¿› `lib.InitTestChassis()` å®¹é”™èƒ½åŠ›**

```go
// å»ºè®®ä¿®æ”¹ lib/test_env_config.go
func initTestChassisOnce() {
    // ... ç°æœ‰è·¯å¾„æŸ¥æ‰¾é€»è¾‘ ...
    
    err := chassis.Init()
    if err != nil {
        // ä¸å† panicï¼Œæ”¹ä¸ºé™çº§å¤„ç†
        fmt.Printf("WARNING: InitConfig error (CHASSIS_CONF_DIR:%s)\n", chassisPath)
        fmt.Println("Using fallback configuration for testing...")
        
        // åˆå§‹åŒ–åŸºæœ¬é…ç½®
        CommonConfig = &ConfigOptions{IConfig: ConfigCenter{}}
        return  // ä¼˜é›…é€€å‡ºè€Œé panic
    }
}
```

**2. æ·»åŠ  DMS ç¯å¢ƒæ£€æµ‹è¾…åŠ©å‡½æ•°**

```go
// å»ºè®®æ·»åŠ åˆ° lib/test_helper.go
package lib

import "runtime"

// InDmsEnvironment æ£€æµ‹æ˜¯å¦åœ¨ DMS ç¯å¢ƒä¸­è¿è¡Œ
func InDmsEnvironment() bool {
    return runtime.GOOS != "darwin" && runtime.GOOS != "windows"
}

// SafeInitTestChassis å®‰å…¨åˆå§‹åŒ–ï¼Œåœ¨ DMS ç¯å¢ƒä¸­ä¸ panic
func SafeInitTestChassis() error {
    if InDmsEnvironment() {
        CommonConfig = &ConfigOptions{IConfig: ConfigCenter{}}
        return nil
    }
    return InitTestChassisWithError()
}
```

**3. åœ¨ Code Guardian å·¥å…·ä¸­æ·»åŠ ç¯å¢ƒæ£€æµ‹**

å»ºè®®åœ¨ `generate_test_file` å·¥å…·ä¸­ï¼š
- è‡ªåŠ¨æ£€æµ‹è¢«æµ‹ä»£ç æ˜¯å¦ä¾èµ– Chassis åˆå§‹åŒ–
- å¦‚æœä¾èµ–ï¼Œç”Ÿæˆçš„æµ‹è¯•ä»£ç è‡ªåŠ¨æ·»åŠ ç¯å¢ƒæ£€æµ‹é€»è¾‘
- æä¾›è­¦å‘Šæç¤ºç”¨æˆ·æ½œåœ¨çš„ DMS å…¼å®¹æ€§é—®é¢˜

**4. æ·»åŠ  DMS é¢„æ£€åŠŸèƒ½**

å»ºè®®åœ¨ `execute_test` å·¥å…·ä¸­ï¼š
- æ¨¡æ‹Ÿ DMS ç¯å¢ƒï¼ˆå¦‚è®¾ç½® GOOS=linuxï¼‰è¿è¡Œæµ‹è¯•
- æå‰å‘ç°å¯èƒ½åœ¨ DMS ä¸­å¤±è´¥çš„æµ‹è¯•
- åœ¨æœ¬åœ°é˜¶æ®µå°±ç»™å‡ºä¿®å¤å»ºè®®

### 8.4 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | æè¿° |
|-------|------|
| **äº¤äº’å¼ç¡®è®¤** | åœ¨å…³é”®æ­¥éª¤å‰è¯¢é—®ç”¨æˆ·ç¡®è®¤ |
| **è¿›åº¦å¯è§†åŒ–** | æ˜¾ç¤ºå½“å‰æ‰§è¡Œæ­¥éª¤å’Œæ•´ä½“è¿›åº¦ |
| **é”™è¯¯æç¤º** | æä¾›æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œä¿®å¤å»ºè®® |
| **å†å²è®°å½•** | ä¿å­˜æ‰§è¡Œå†å²ï¼Œæ”¯æŒæŸ¥çœ‹å’Œå¯¹æ¯” |
| **æ‰¹é‡å¤„ç†** | æ”¯æŒåŒæ—¶å¤„ç†å¤šä¸ªä»£ç å— |

---

## 9. é™„å½•

### 9.1 ç›¸å…³æ–‡æ¡£é“¾æ¥

- [é¡¹ç›®å•å…ƒæµ‹è¯•è§„èŒƒ](/.cursor/rules/unit-test/)
- [Go å¸¸è§é™·é˜±æŒ‡å—](/.cursor/rules/knowledge/go-common-pitfalls.mdc)
- [gomonkey ä½¿ç”¨æŒ‡å—](/.cursor/rules/unit-test/knowledge/gomonkey-runtime-errors.mdc)

### 9.2 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|-----|------|---------|
| v1.0 | 2026-01-13 | åˆå§‹ç‰ˆæœ¬å‘å¸ƒ |
| v1.1 | 2026-01-13 | æ·»åŠ  fleetorder-service ä½¿ç”¨æ¡ˆä¾‹ï¼ˆé—®é¢˜æ¡ˆä¾‹ï¼‰ï¼›æ–°å¢ DMS ç¯å¢ƒå…¼å®¹æ€§é—®é¢˜è¯´æ˜ï¼›è¡¥å……æœ¬åœ°æµ‹è¯•é€šè¿‡ä½† DMS å¤±è´¥çš„è§£å†³æ–¹æ¡ˆï¼›æ·»åŠ  DMS ç¯å¢ƒå…¼å®¹æ€§ä¼˜åŒ–å»ºè®® |

### 9.3 åé¦ˆä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- **Slack**: #spx-fulfillment-dev
- **é‚®ç®±**: spx-fulfillment-team@shopee.com

---

> ğŸ“Œ **æ³¨æ„**: æœ¬å·¥å…·æŒç»­è¿­ä»£ä¼˜åŒ–ä¸­ï¼Œå¦‚é‡åˆ°é—®é¢˜è¯·åŠæ—¶åé¦ˆï¼Œå¸®åŠ©æˆ‘ä»¬æ”¹è¿›å·¥å…·è´¨é‡ã€‚
